---
# JuiceFS Database Initialization for Sandbox Platform
#
# This manifest initializes the JuiceFS metadata database in MariaDB.
# For hostPath mounting, we only need the database, not CSI Driver resources.
#
# Prerequisites:
# - MariaDB must be deployed (08-mariadb-deployment.yaml)
# - MinIO must be deployed (07-minio-deployment.yaml)
#
# Installation:
#   kubectl apply -f deploy/k8s/09-juicefs-setup.yaml
#
# Verification:
#   kubectl get job -n sandbox-system juicefs-db-init
#   kubectl logs -n sandbox-system job/juicefs-db-init

---
# ConfigMap for JuiceFS database initialization script
apiVersion: v1
kind: ConfigMap
metadata:
  name: juicefs-init-script
  namespace: sandbox-system
data:
  init-juicefs-db.sql: |
    -- JuiceFS Metadata Database Initialization
    --
    -- This script creates the database and user for JuiceFS metadata storage.
    -- JuiceFS stores file metadata (directory structure, attributes, chunks)
    -- in MariaDB, while actual file data is stored in MinIO.
    --
    -- IMPORTANT: This script should be run during initial setup.
    --
    -- Usage:
    --   kubectl exec -n sandbox-system deployment/mariadb -- mysql -u root -p"password" < /init/init-juicefs-db.sql

    -- Create JuiceFS metadata database
    CREATE DATABASE IF NOT EXISTS juicefs_metadata
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

    -- Create dedicated user for JuiceFS (optional, can reuse root)
    -- CHANGE THE PASSWORD IN PRODUCTION!
    CREATE USER IF NOT EXISTS 'juicefs'@'%' IDENTIFIED BY 'juicefs_password';

    -- Grant all privileges on JuiceFS database
    GRANT ALL PRIVILEGES ON juicefs_metadata.* TO 'juicefs'@'%';

    -- Flush privileges to ensure changes take effect
    FLUSH PRIVILEGES;

    -- Verification query (run this to confirm database is ready)
    USE juicefs_metadata;

    SELECT 'JuiceFS database initialized successfully' AS status;

---
# Job to initialize JuiceFS database (run once during installation)
apiVersion: batch/v1
kind: Job
metadata:
  name: juicefs-db-init
  namespace: sandbox-system
spec:
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-mariadb
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z mariadb.sandbox-system.svc.cluster.local 3306; do
                echo "Waiting for MariaDB..."
                sleep 2
              done
              echo "MariaDB is ready!"
        - name: create-db
          image: mariadb:11.2
          command:
            - sh
            - -c
            - |
              echo "Creating JuiceFS database..."
              mariadb -h mariadb.sandbox-system.svc.cluster.local \
                    -u root \
                    -p"password" \
                    < /init/init-juicefs-db.sql
              echo "JuiceFS database created!"
              echo "DB" > /shared/status
          volumeMounts:
            - name: init-script
              mountPath: /init
            - name: shared
              mountPath: /shared
      containers:
        - name: format-juicefs
          image: juicedata/juicefs-fuse:ce-nightly
          command:
            - sh
            - -c
            - |
              echo "Checking database status..."
              ls -la /shared/

              echo "Formatting JuiceFS filesystem..."

              # Set up environment variables for S3/MinIO
              export AWS_ACCESS_KEY_ID="minioadmin"
              export AWS_SECRET_ACCESS_KEY="minioadmin"

              # Find juicefs binary
              JFS_BIN=$(command -v juicefs || echo "/usr/local/bin/juicefs")

              # Format the JuiceFS filesystem
              # This creates the necessary tables and structure in the database
              "${JFS_BIN}" format \
                  --storage="minio" \
                  --bucket="http://minio.sandbox-system.svc.cluster.local:9000/sandbox-workspace" \
                  --access-key="minioadmin" \
                  --secret-key="minioadmin" \
                  "mysql://root:password@tcp(mariadb.sandbox-system.svc.cluster.local:3306)/juicefs_metadata" \
                  "sandbox-workspace"

              echo "JuiceFS filesystem formatted successfully!"
              echo "JuiceFS database initialization completed!"
          volumeMounts:
            - name: shared
              mountPath: /shared
      volumes:
        - name: init-script
          configMap:
            name: juicefs-init-script
        - name: shared
          emptyDir: {}
