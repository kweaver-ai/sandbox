# æ²™ç®±å¹³å°ç«¯åˆ°ç«¯é›†æˆæ–¹æ¡ˆ
## åŸºäº PTC æ•°æ®åˆ†æä¸ä¸Šä¸‹æ–‡é—®ç­”çš„ç»Ÿä¸€ä¸´æ—¶åŒºåœºæ™¯

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-01-05
**çŠ¶æ€**: è®¾è®¡éªŒè¯

---

## 1. æ–‡æ¡£æ¦‚è¿°

### 1.1 ç›®çš„

æœ¬æ–‡æ¡£åŸºäº `sandbox-design-v1.md` ç¬¬ 1.4 èŠ‚å®šä¹‰çš„**é¢å‘ PTC æ•°æ®åˆ†æ + ä¸Šä¸‹æ–‡é—®ç­”çš„ç»Ÿä¸€æ²™ç®±ä¸´æ—¶åŒº**ä¸šåŠ¡åœºæ™¯ï¼Œç»“åˆ `sandbox-design-v2.1.md` çš„å®Œæ•´æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆï¼Œè¿›è¡Œç«¯åˆ°ç«¯åœºæ™¯éªŒè¯ï¼Œå¹¶å½¢æˆå®Œæ•´çš„é›†æˆå®æ–½æŒ‡å—ã€‚

### 1.2 æ ¸å¿ƒåœºæ™¯å®šä¹‰

æ²™ç®±å¹³å°éœ€åŒæ—¶æ”¯æŒä¸¤ç±»æ–‡ä»¶å¤„ç†éœ€æ±‚ï¼š

| åœºæ™¯ç±»å‹ | PTC æ•°æ®åˆ†æåœºæ™¯ | é PTC é—®ç­”åœºæ™¯ |
|---------|-----------------|----------------|
| **æ ¸å¿ƒå®šä¹‰** | **Agent ç”Ÿæˆä»£ç ** â†’ æ²™ç®±æ‰§è¡Œ â†’ ç»“æœè¿”å› Agent â†’ ç»§ç»­æ¨ç† | **Agent ä¸Šä¼ æ–‡ä»¶** â†’ æ²™ç®±å­˜å‚¨ â†’ Agent å¤šè½®è¯»å–åˆ†æ â†’ æ¨ç† |
| **è§¦å‘æ–¹å¼** | Agent é€šè¿‡**ç¨‹åºåŒ–å·¥å…·è°ƒç”¨**ï¼ˆPTCï¼‰è‡ªåŠ¨ç”Ÿæˆå¹¶æäº¤ä»£ç  | Agent è°ƒç”¨æ–‡ä»¶ä¸Šä¼ å·¥å…· â†’ åç»­è°ƒç”¨ä»£ç è¯»å–æ–‡ä»¶ |
| **æ‰§è¡Œæ¨¡å¼** | Python ä»£ç æ‰§è¡Œï¼ˆpandas, numpyï¼‰ | æ–‡ä»¶è§£æ + å†…å®¹æŠ½å– |
| **äº¤äº’å¾ªç¯** | **å¤šè½®è¿­ä»£**ï¼šAgent åå¤ç”Ÿæˆä»£ç ã€æ‰§è¡Œã€åˆ†æç»“æœã€å†ç”Ÿæˆæ–°ä»£ç  | **å¤šè½®è¯»å–**ï¼šAgent ä¸Šä¼ åï¼Œå¯å¤šæ¬¡è°ƒç”¨ä»£ç è¯»å–ä¸åŒéƒ¨åˆ† |
| **éš”ç¦»è¦æ±‚** | é«˜éš”ç¦»æ²™ç®±ç¯å¢ƒï¼ˆé˜²æ­¢ç”Ÿæˆä»£ç é€ƒé€¸ï¼‰ | å®‰å…¨è§£æä¸­é—´å±‚ |
| **æ–‡ä»¶æŒä¹…åŒ–** | éœ€è¦ä¸­é—´ç»“æœæŒä¹…åŒ–ï¼ˆæ”¯æŒå¤šæ­¥éª¤åˆ†æï¼‰ | éœ€è¦æ–‡ä»¶æŒä¹…åŒ–ï¼ˆå¤šè½®å¯¹è¯ä¸­é‡å¤è¯»å–ï¼‰ |
| **ç½‘ç»œéœ€æ±‚** | å¯èƒ½éœ€è¦å¤–éƒ¨æ•°æ®ï¼ˆAPI è°ƒç”¨ï¼‰ | é»˜è®¤æ— ç½‘ç»œ |
| **ä¼šè¯æ¨¡å‹** | ç»Ÿä¸€ä¼šè¯ï¼ˆåŸºäº Agent ID å¤ç”¨ï¼‰ | ç»Ÿä¸€ä¼šè¯ï¼ˆåŸºäº Agent ID å¤ç”¨ï¼‰ |

**åœºæ™¯ä¸€ï¼šPTC æ•°æ®åˆ†æ - Agent ä»£ç ç”Ÿæˆä¸æ‰§è¡Œå¾ªç¯**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PTC (Programmatic Tool Call)                 â”‚
â”‚                    Agent ä»£ç ç”Ÿæˆä¸æ‰§è¡Œå¾ªç¯                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ğŸ¤– Agent      â”‚         â”‚  ğŸ›¡ï¸ æ²™ç®±       â”‚                 â”‚
â”‚  â”‚  (LLM æ¨ç†)    â”‚         â”‚  (ä»£ç æ‰§è¡Œ)    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚    â‘  ç”Ÿæˆä»£ç                    â‘¡ æ‰§è¡Œä»£ç                       â”‚
â”‚    "è¯»å–CSV,ç»Ÿè®¡å‡å€¼"            "pandasè®¡ç®—"                   â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”‚                    â‘¢ è¿”å›ç»“æœ                        â”‚
â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚      â‘£ åˆ†æç»“æœ                                                      â”‚
â”‚    "å‡å€¼æ˜¯ 42.5ï¼Œéœ€è¦å¯è§†åŒ–"                                     â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚    â‘¤ ç”Ÿæˆæ–°ä»£ç                   â‘¥ æ‰§è¡Œæ–°ä»£ç                     â”‚
â”‚    "ç”¨matplotlibç”»å›¾"            "ç”Ÿæˆå›¾è¡¨"                       â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”‚                    â‘¦ è¿”å›å›¾è¡¨                        â”‚
â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚      â‘§ æœ€ç»ˆæ¨ç†                                                      â”‚
â”‚    "æ•°æ®å‘ˆæ­£æ€åˆ†å¸ƒ"                                               â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â–¼                          â–¼                          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚      â”‚ è¿”å›ç”¨æˆ· â”‚              â”‚ä¼šè¯ä¿æŒ  â”‚                      â”‚
â”‚      â”‚ ç­”æ¡ˆ    â”‚              â”‚ï¼ˆå¯å¤ç”¨ï¼‰ â”‚                      â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**å…³é”®ç‰¹å¾**ï¼š
1. Agent è‡ªä¸»ç”Ÿæˆä»£ç ï¼ˆéäººå·¥ç¼–å†™ï¼‰
2. æ²™ç®±ä½œä¸º"å·¥å…·"è¢« Agent è°ƒç”¨
3. æ‰§è¡Œç»“æœåé¦ˆç»™ Agent ç”¨äºä¸‹ä¸€æ­¥æ¨ç†
4. å½¢æˆé—­ç¯ï¼šç”Ÿæˆ â†’ æ‰§è¡Œ â†’ åˆ†æ â†’ å†ç”Ÿæˆ
5. ä¼šè¯ä¿æŒæ´»è·ƒï¼Œæ”¯æŒå¤šè½®è¿­ä»£
```

**åœºæ™¯äºŒï¼šé PTC é—®ç­” - Agent æ–‡ä»¶ä¸Šä¼ ä¸å¤šè½®è¯»å–**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é PTC é—®ç­”ï¼šæ–‡ä»¶å¤šè½®è¯»å–                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ğŸ‘¤ ç”¨æˆ·       â”‚         â”‚  ğŸ¤– Agent      â”‚                 â”‚
â”‚  â”‚  ä¸Šä¼ æ–‡ä»¶      â”‚         â”‚  (LLM æ¨ç†)    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”‚ â‘  ä¸Šä¼  PDF               â”‚                          â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”‚                    â‘¡ è°ƒç”¨æ–‡ä»¶ä¸Šä¼ å·¥å…·                  â”‚
â”‚           â”‚                          â”‚                          â”‚
â”‚           â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚           â”‚           â”‚               â”‚               â”‚          â”‚
â”‚           â”‚           â–¼               â–¼               â–¼          â”‚
â”‚           â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚           â”‚      â”‚ ğŸ›¡ï¸ æ²™ç®±  â”‚    â”‚ ğŸ›¡ï¸ æ²™ç®±  â”‚    â”‚ ğŸ›¡ï¸ æ²™ç®±  â”‚       â”‚
â”‚           â”‚      â”‚ å­˜å‚¨æ–‡ä»¶ â”‚    â”‚ è¯»å–    â”‚    â”‚ è¯»å–    â”‚       â”‚
â”‚           â”‚      â”‚åˆ°workspaceâ”‚   â”‚ç¬¬1-10é¡µ â”‚   â”‚ç¬¬11-20é¡µâ”‚       â”‚
â”‚           â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚           â”‚               â”‚               â”‚          â”‚
â”‚           â”‚           â”‚ â‘¢ æ–‡ä»¶å·²ä¸Šä¼   â”‚ â‘£ è¿”å›å‰10é¡µ   â”‚ â‘¤ è¿”å›å10é¡µâ”‚
â”‚           â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           â”‚                          â”‚               â”‚          â”‚
â”‚           â”‚                    â‘¥ åˆ†æå‰10é¡µ     â‘¦ åˆ†æå10é¡µ    â”‚
â”‚           â”‚                          â”‚               â”‚          â”‚
â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           â”‚                                                          â”‚
â”‚           â”‚ â‘§ ç»¼åˆå›ç­”ï¼š"æ–‡æ¡£åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‰åŠéƒ¨åˆ†è®²..."              â”‚
â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚           â”‚                                                          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                                â”‚
â”‚      â”‚  å±•ç¤ºç­”æ¡ˆ  â”‚                                                â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                  â”‚
â”‚  **å…³é”®ç‰¹å¾**ï¼š                                                    â”‚
â”‚  1. æ–‡ä»¶ä¸€æ¬¡æ€§ä¸Šä¼ åˆ°æ²™ç®± workspace                                 â”‚
â”‚  2. Agent å¯å¤šæ¬¡è°ƒç”¨ä»£ç è¯»å–åŒä¸€æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†                       â”‚
â”‚  3. æ¯æ¬¡è¯»å–ç»“æœè¿”å›ç»™ Agent è¿›è¡Œæ¨ç†                              â”‚
â”‚  4. æ”¯æŒå¤šè½®å¯¹è¯ä¸­åå¤å¼•ç”¨åŒä¸€æ–‡ä»¶                                  â”‚
â”‚  5. ä¼šè¯ä¿æŒæ´»è·ƒï¼Œæ–‡ä»¶æŒç»­å¯è®¿é—®                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 API è®¾è®¡ï¼šå¼‚æ­¥ vs åŒæ­¥

**æ ¸å¿ƒé—®é¢˜**ï¼šv2.1 è®¾è®¡ä¸­ä»£ç æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ï¼ˆè¿”å› execution_id åéœ€è¦è½®è¯¢ç»“æœï¼‰ï¼Œè¿™å¯¹ Agent è°ƒç”¨æ˜¯å¦å‹å¥½ï¼Ÿ

#### 1.3.1 å½“å‰å¼‚æ­¥ API æ¨¡å¼

```python
# v2.1 è®¾è®¡çš„å¼‚æ­¥ API æ¨¡å¼
POST /api/v1/sessions/{id}/execute
Request: {code: "...", language: "python"}
Response: {"execution_id": "exec_123", "status": "submitted"}

# Agent éœ€è¦è½®è¯¢ç»“æœ
GET /api/v1/executions/exec_123/result
# åå¤è°ƒç”¨ç›´åˆ° status == "completed"
```

**å¯¹ Agent çš„å½±å“**ï¼š
- âŒ éœ€è¦å®ç°è½®è¯¢é€»è¾‘ï¼ˆå¢åŠ å¤æ‚åº¦ï¼‰
- âŒ å¤šæ¬¡ç½‘ç»œå¾€è¿”ï¼ˆå¢åŠ å»¶è¿Ÿï¼‰
- âŒ éœ€è¦å¤„ç†è¶…æ—¶å’Œé”™è¯¯é‡è¯•
- âœ… æ”¯æŒé•¿æ—¶é—´æ‰§è¡Œï¼ˆä¸é˜»å¡ HTTP è¿æ¥ï¼‰
- âœ… å¯å¹¶å‘æäº¤å¤šä¸ªä»»åŠ¡

#### 1.3.2 åŒæ­¥ APIï¼ˆå·¥å…·å±‚å°è£…ï¼‰

**æ–¹æ¡ˆ**ï¼šåœ¨å·¥å…·å±‚åšå°è£…ï¼Œå®ç°é˜»å¡ç­‰å¾…ï¼Œå¯¹ Agent æä¾›åŒæ­¥æ¥å£ï¼š

```python
# å·¥å…·å±‚å°è£…ï¼šåŒæ­¥ç­‰å¾…ç»“æœ
async def execute_code_sync(session_id: str, code: str, timeout: int = 300):
    """åŒæ­¥æ‰§è¡Œä»£ç ï¼Œå·¥å…·å±‚å°è£…å¼‚æ­¥è½®è¯¢"""

    # 1. æäº¤æ‰§è¡Œä»»åŠ¡
    response = await http_client.post(
        f"{SANDBOX_API}/api/v1/sessions/{session_id}/execute",
        json={"code": code, "language": "python"}
    )
    execution_id = response.json()["execution_id"]

    # 2. è½®è¯¢ç­‰å¾…ç»“æœï¼ˆå·¥å…·å±‚å¤„ç†ï¼‰
    start_time = time.time()
    while True:
        result_response = await http_client.get(
            f"{SANDBOX_API}/api/v1/executions/{execution_id}/result"
        )
        result = result_response.json()

        if result["status"] in ["completed", "failed", "timeout"]:
            return result  # ç›´æ¥è¿”å›ç»“æœ

        # è¶…æ—¶æ£€æŸ¥
        if time.time() - start_time > timeout:
            raise TimeoutError(f"Execution timeout after {timeout}s")

        # é€€é¿è½®è¯¢
        await asyncio.sleep(0.5)

# Agent è°ƒç”¨ï¼ˆåŒæ­¥è¯­ä¹‰ï¼‰
result = await execute_code_sync(
    session_id="sess_123",
    code="import pandas as pd\ndf = pd.read_csv('/workspace/data.csv')\nreturn df.describe()",
    timeout=60
)
print(result["return_value"])  # ç›´æ¥ä½¿ç”¨ç»“æœ
```

**ä¼˜åŠ¿**ï¼š
- âœ… Agent è°ƒç”¨ç®€å•ï¼Œç±»ä¼¼å‡½æ•°è°ƒç”¨
- âœ… å·¥å…·å±‚ç»Ÿä¸€å¤„ç†è½®è¯¢ã€è¶…æ—¶ã€é”™è¯¯
- âœ… é™ä½ Agent é›†æˆå¤æ‚åº¦

**åŠ£åŠ¿**ï¼š
- âš ï¸ é•¿æ—¶é—´æ‰§è¡Œä¼šé˜»å¡ï¼ˆä½†å¯é€šè¿‡è¶…æ—¶æ§åˆ¶ï¼‰
- âš ï¸ å¹¶å‘æ‰§è¡Œéœ€è¦å¤šä¸ªå·¥å…·è°ƒç”¨å®ä¾‹

#### 1.3.3 æ··åˆæ¨¡å¼ï¼šæ¨èæ–¹æ¡ˆ

```python
class SandboxTool:
    """æ²™ç®±å·¥å…·ï¼šåŒæ—¶æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ¥å£"""

    async def execute_sync(self, code: str, timeout: int = 300):
        """åŒæ­¥æ¥å£ï¼šé˜»å¡ç­‰å¾…ç»“æœï¼ˆé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼‰"""
        execution_id = await self._submit(code)
        return await self._wait_for_result(execution_id, timeout)

    async def execute_async(self, code: str):
        """å¼‚æ­¥æ¥å£ï¼šç«‹å³è¿”å› execution_idï¼ˆé€‚åˆé•¿æ—¶é—´ä»»åŠ¡ï¼‰"""
        execution_id = await self._submit(code)
        return {
            "execution_id": execution_id,
            "status": "submitted",
            "poll_url": f"/api/v1/executions/{execution_id}/result"
        }

    async def get_result(self, execution_id: str):
        """æŸ¥è¯¢ç»“æœï¼šé…åˆå¼‚æ­¥æ¥å£ä½¿ç”¨"""
        return await http_client.get(
            f"{SANDBOX_API}/api/v1/executions/{execution_id}/result"
        )
```

**æ¨èä½¿ç”¨ç­–ç•¥**ï¼š

| åœºæ™¯ | æ¨èæ¥å£ | åŸå›  |
|------|---------|------|
| PTC æ•°æ®åˆ†æï¼ˆå¤§å¤šæ•°æƒ…å†µï¼‰ | `execute_sync()` | æ‰§è¡Œæ—¶é—´çŸ­ï¼ˆ< 30sï¼‰ï¼Œé˜»å¡ç­‰å¾…æ›´ç®€å• |
| PTC æ•°æ®åˆ†æï¼ˆé•¿æ—¶é—´ä»»åŠ¡ï¼‰ | `execute_async()` | æ‰§è¡Œæ—¶é—´é•¿ï¼ˆ> 30sï¼‰ï¼Œé¿å…è¶…æ—¶ |
| é PTC æ–‡ä»¶è§£æ | `execute_sync()` | å•æ¬¡è§£æï¼Œæ—¶é—´å¯æ§ |
| æ‰¹é‡å¹¶å‘ä»»åŠ¡ | `execute_async()` + å¹¶å‘è½®è¯¢ | æé«˜ååé‡ |

#### 1.3.4 API è®¾è®¡æ€»ç»“

| å±‚çº§ | æ¥å£ç±»å‹ | è¿”å›æ¨¡å¼ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| **æ²™ç®±å¹³å° API** | å¼‚æ­¥ | ç«‹å³è¿”å› execution_id | é•¿æ—¶é—´ä»»åŠ¡ã€é«˜å¹¶å‘ |
| **å·¥å…·å±‚å°è£…** | åŒæ­¥ï¼ˆé»˜è®¤ï¼‰ | é˜»å¡ç­‰å¾…ç»“æœ | çŸ­æ—¶é—´ä»»åŠ¡ã€ç®€å•é›†æˆ |
| **å·¥å…·å±‚å°è£…** | å¼‚æ­¥ï¼ˆå¯é€‰ï¼‰ | ç«‹å³è¿”å› execution_id | é•¿æ—¶é—´ä»»åŠ¡ã€é«˜çº§ç”¨æˆ· |

**å»ºè®®**ï¼š
1. **æ²™ç®±å¹³å°ä¿æŒå¼‚æ­¥ API**ï¼šæ€§èƒ½æœ€ä¼˜ï¼Œçµæ´»æ€§æœ€é«˜
2. **å·¥å…·å±‚æä¾›åŒæ­¥å°è£…**ï¼šé™ä½ Agent é›†æˆé—¨æ§›
3. **æ–‡æ¡£å¼ºè°ƒåŒæ­¥æ¥å£**ï¼šå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨åŒæ­¥æ¨¡å¼

---

### 1.4 è®¾è®¡ç›®æ ‡

éªŒè¯ v2.1 æ¶æ„èƒ½å¦æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒéœ€æ±‚ï¼š

1. **ç»Ÿä¸€ä¸´æ—¶åŒºèƒ½åŠ›**ï¼šåŒä¸€æ²™ç®±å®ä¾‹æ—¢èƒ½æ‰§è¡Œ Python ä»£ç ï¼Œåˆèƒ½è§£æå„ç±»æ–‡ä»¶æ ¼å¼
2. **ç»Ÿä¸€ä¼šè¯æ¨¡å‹**ï¼šåŸºäº Agent ID çš„ä¼šè¯å¤ç”¨ï¼Œæ”¯æŒ PTC å’Œé—®ç­”åœºæ™¯
3. **æ–‡ä»¶å¤„ç†æµç¨‹**ï¼šæ”¯æŒæ–‡ä»¶ä¸Šä¼ ã€è§£æã€ç»“æœè¿”å›çš„å®Œæ•´é“¾è·¯
4. **Agent å‹å¥½ API**ï¼šå·¥å…·å±‚æä¾›åŒæ­¥å°è£…ï¼Œç®€åŒ– Agent é›†æˆ
5. **æ™ºèƒ½è°ƒåº¦**ï¼šAgent äº²å’Œæ€§è°ƒåº¦ï¼Œä¼˜å…ˆå¤ç”¨å·²æœ‰ä¼šè¯
6. **èµ„æºéš”ç¦»ä¸å®‰å…¨**ï¼šåŒå±‚éš”ç¦»æœºåˆ¶ç¡®ä¿ä¸é€ƒé€¸
7. **æ€§èƒ½è¦æ±‚**ï¼šå†·å¯åŠ¨ < 5sï¼Œçƒ­å¯åŠ¨ < 100msï¼Œæ‰§è¡Œå“åº” < 500ms

---

## 2. æ¶æ„æ˜ å°„

### 2.1 åœºæ™¯åˆ°æ¶æ„çš„æ˜ å°„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç»Ÿä¸€æ²™ç®±ä¸´æ—¶åŒºï¼ˆä¸šåŠ¡è§†å›¾ï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ PTC æ•°æ®åˆ†æ     â”‚         â”‚ é PTC é—®ç­”      â”‚             â”‚
â”‚  â”‚ - Python æ‰§è¡Œ    â”‚         â”‚ - æ–‡ä»¶è§£æ       â”‚             â”‚
â”‚  â”‚ - pandas/numpy   â”‚         â”‚ - PDF/OCR/CSV    â”‚             â”‚
â”‚  â”‚ - Agent å¤ç”¨ session     â”‚         â”‚ - Agent å¤ç”¨ session     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                            â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                       â–¼                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚           â”‚   ç»Ÿä¸€æ²™ç®±ä¸´æ—¶åŒº       â”‚                            â”‚
â”‚           â”‚ - æ–‡ä»¶æŒä¹…åŒ–          â”‚                            â”‚
â”‚           â”‚ - å¤æ‚ä¾èµ–å…¼å®¹        â”‚                            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    v2.1 æŠ€æœ¯æ¶æ„ï¼ˆå®ç°è§†å›¾ï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Control Planeï¼ˆç®¡ç†ä¸­å¿ƒï¼‰                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ API GW   â”‚  â”‚Scheduler â”‚  â”‚Session   â”‚  â”‚Templateâ”‚  â”‚   â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚Manager   â”‚  â”‚Manager â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Runtime Poolï¼ˆè¿è¡Œæ—¶æ± ï¼‰                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚ Warm Pool      â”‚         â”‚ Active Runtime â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ - é¢„çƒ­å®ä¾‹     â”‚         â”‚ - æ‰§è¡Œä¸­å®¹å™¨   â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Containerï¼ˆå®¹å™¨å®ä¾‹ï¼‰                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚         sandbox-executorï¼ˆHTTP å®ˆæŠ¤è¿›ç¨‹ï¼‰     â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚                     â”‚ Bubblewrap                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚         User Code Processï¼ˆç”¨æˆ·ä»£ç è¿›ç¨‹ï¼‰      â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  - PTC: Python pandas/numpy                  â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  - é—®ç­”: PDF/OCR/CSV è§£æå™¨                  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Storageï¼ˆå­˜å‚¨å±‚ï¼‰                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ MariaDB â”‚  â”‚   S3    â”‚  â”‚  Etcd   â”‚  â”‚  Redis  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ ä¼šè¯/   â”‚  â”‚workspaceâ”‚  â”‚ é…ç½®    â”‚  â”‚ ç¼“å­˜    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ æ¨¡æ¿    â”‚  â”‚ æ–‡ä»¶    â”‚  â”‚         â”‚  â”‚         â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç»Ÿä¸€ä¼šè¯æ¨¡å‹ï¼šAgent ä¾§ç»´æŠ¤ Session ID

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼šä¼šè¯ç®¡ç†å®Œå…¨ç”± Agent ä¾§è´Ÿè´£ï¼Œæ²™ç®±å¹³å°æä¾›çº¯ç²¹çš„æ‰§è¡Œèƒ½åŠ›ï¼Œæ— éœ€çŸ¥é“ Agent æ¦‚å¿µã€‚

#### 2.2.1 æ¶æ„è§£è€¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¼šè¯ç®¡ç†èŒè´£åˆ’åˆ†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Agent ä¾§          â”‚         â”‚  æ²™ç®±å¹³å°ä¾§        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                             â”‚                       â”‚
â”‚  âœ… è´Ÿè´£ï¼š                        âœ… è´Ÿè´£ï¼š                  â”‚
â”‚  - åˆ›å»º session                 - æä¾›æ‰§è¡Œ API              â”‚
â”‚  - ç»´æŠ¤ session_id              - æ¥æ”¶ session_id + code     â”‚
â”‚  - å†³å®šä½•æ—¶å¤ç”¨                 - æ‰§è¡Œä»£ç å¹¶è¿”å›ç»“æœ         â”‚
â”‚  - å†³å®šä½•æ—¶é”€æ¯                 - æä¾›åŸºç¡€è°ƒåº¦               â”‚
â”‚  - å®ç°å¤šè½®å¤ç”¨é€»è¾‘             - æ— éœ€çŸ¥é“ Agent æ¦‚å¿µ        â”‚
â”‚                                                                  â”‚
â”‚  âŒ ä¸è´Ÿè´£ï¼š                      âŒ ä¸è´Ÿè´£ï¼š                â”‚
â”‚  - ç»´æŠ¤ Agent â†’ Session æ˜ å°„    - Agent äº²å’Œæ€§è°ƒåº¦           â”‚
â”‚  - Agent æ¦‚å¿µ                   - ä¼šè¯å¤ç”¨å†³ç­–              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**ä¼˜åŠ¿**ï¼š
1. **è§£è€¦**ï¼šæ²™ç®±å¹³å°æ— éœ€çŸ¥é“ Agent æ¦‚å¿µï¼Œä¸“æ³¨äºæ‰§è¡Œèƒ½åŠ›
2. **çµæ´»**ï¼šAgent å¯ä»¥è‡ªç”±å†³å®š session ç”Ÿå‘½å‘¨æœŸå’Œå¤ç”¨ç­–ç•¥
3. **ç®€å•**ï¼šæ²™ç®±å¹³å° API æ›´ç®€å•ï¼Œåªéœ€æä¾›åŸºç¡€ CRUD
4. **å¯æ§**ï¼šAgent å®Œå…¨æ§åˆ¶è‡ªå·±çš„ä¼šè¯ç®¡ç†é€»è¾‘
```

#### 2.2.2 Agent ä¾§ä¼šè¯ç®¡ç†

```python
class SandboxSession:
    """
    Agent ä¾§çš„ä¼šè¯ç®¡ç†å™¨

    èŒè´£ï¼š
    1. åˆ›å»ºå’Œé”€æ¯ session
    2. ç»´æŠ¤ session_idï¼ˆå†…å­˜ç¼“å­˜ï¼‰
    3. å†³å®šä½•æ—¶å¤ç”¨ session
    4. å®ç° session ç”Ÿå‘½å‘¨æœŸç®¡ç†
    """

    def __init__(self, template_id: str = "python-datascience"):
        self.template_id = template_id
        self.api_base = os.environ["SANDBOX_API"]
        self.session_id: Optional[str] = None  # Agent ç»´æŠ¤çš„ session ID
        self.last_used: Optional[datetime] = None

    async def ensure_session(self) -> str:
        """
        ç¡®ä¿ session å­˜åœ¨ï¼ˆå¤ç”¨æˆ–åˆ›å»ºï¼‰

        Returns:
            session_id: ä¼šè¯ ID
        """
        # 1ï¸âƒ£ å¦‚æœå·²æœ‰ session ä¸”ä»ç„¶æ´»è·ƒï¼Œç›´æ¥å¤ç”¨
        if self.session_id and await self._is_session_active():
            logger.info(f"âœ… Reusing existing session: {self.session_id}")
            return self.session_id

        # 2ï¸âƒ£ å¦‚æœæ²¡æœ‰ session æˆ–å·²è¿‡æœŸï¼Œåˆ›å»ºæ–° session
        if self.session_id:
            logger.info(f"ğŸ”„ Session expired, creating new session")

        response = await http_client.post(
            f"{self.api_base}/api/v1/sessions",
            json={
                "template_id": self.template_id,
                "timeout": 3600,  # 1 å°æ—¶è¶…æ—¶
                "resources": {
                    "cpu": "2",
                    "memory": "2Gi",
                    "disk": "5Gi"
                }
            }
        )

        self.session_id = response.json()["session_id"]
        self.last_used = datetime.now()
        logger.info(f"âœ… Created new session: {self.session_id}")

        return self.session_id

    async def execute(self, code: str, timeout: int = 300) -> dict:
        """
        æ‰§è¡Œä»£ç ï¼ˆè‡ªåŠ¨å¤„ç† sessionï¼‰

        Args:
            code: Python ä»£ç 
            timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

        Returns:
            æ‰§è¡Œç»“æœï¼ˆreturn_value, stdout, stderr ç­‰ï¼‰
        """
        # 1. ç¡®ä¿ session å­˜åœ¨
        session_id = await self.ensure_session()

        # 2. æäº¤æ‰§è¡Œä»»åŠ¡ï¼ˆæŒ‡å®š session_idï¼‰
        response = await http_client.post(
            f"{self.api_base}/api/v1/sessions/{session_id}/execute",
            json={
                "code": code,
                "language": "python",
                "timeout": timeout
            }
        )

        execution_id = response.json()["execution_id"]

        # 3. ç­‰å¾…ç»“æœï¼ˆå·¥å…·å±‚æä¾›åŒæ­¥ç­‰å¾…ï¼‰
        result = await self._wait_for_result(execution_id, timeout)

        # 4. æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
        self.last_used = datetime.now()

        return result

    async def cleanup(self):
        """é”€æ¯ session"""
        if self.session_id:
            await http_client.delete(
                f"{self.api_base}/api/v1/sessions/{self.session_id}"
            )
            logger.info(f"ğŸ—‘ï¸ Destroyed session: {self.session_id}")
            self.session_id = None

    async def _is_session_active(self) -> bool:
        """æ£€æŸ¥ session æ˜¯å¦ä»ç„¶æ´»è·ƒ"""
        if not self.session_id:
            return False

        try:
            response = await http_client.get(
                f"{self.api_base}/api/v1/sessions/{self.session_id}"
            )
            data = response.json()
            return data["status"] == "running"
        except httpx.HTTPStatusError as e:
            if e.response.status_code == 404:
                return False
            raise

    async def _wait_for_result(self, execution_id: str, timeout: int) -> dict:
        """ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆåŒæ­¥è¯­ä¹‰ï¼‰"""
        start = time.time()
        while True:
            response = await http_client.get(
                f"{self.api_base}/api/v1/executions/{execution_id}/result"
            )
            result = response.json()

            if result["status"] in ["completed", "failed", "timeout"]:
                return result

            if time.time() - start > timeout:
                raise TimeoutError(f"Execution timeout after {timeout}s")

            await asyncio.sleep(0.5)
```

#### 2.2.3 Agent ä½¿ç”¨ç¤ºä¾‹

```python
# Agent ä¾§ï¼šä¸€ä¸ª Agent å®ä¾‹å¯¹åº”ä¸€ä¸ª Session
class DataAnalysisAgent:
    """æ•°æ®åˆ†æ Agentï¼šä½¿ç”¨å›ºå®š session"""

    def __init__(self, agent_id: str):
        self.agent_id = agent_id
        # ä¸ºè¿™ä¸ª Agent åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„ session ç®¡ç†å™¨
        self.session = SandboxSession(template_id="python-datascience")

    async def analyze_csv(self, csv_file_path: str):
        """åˆ†æ CSV æ–‡ä»¶"""

        # 1. ä¸Šä¼ æ–‡ä»¶åˆ° session workspace
        await self._upload_file(csv_file_path)

        # 2. æ‰§è¡Œä»£ç ï¼ˆsession è‡ªåŠ¨å¤ç”¨ï¼‰
        # ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šåˆ›å»º sessionï¼ˆ2-5sï¼‰
        result1 = await self.session.execute("""
import pandas as pd

df = pd.read_csv('/workspace/data.csv')
df_clean = df.dropna()

# ä¿å­˜ä¸­é—´ç»“æœ
df_clean.to_csv('/workspace/data_clean.csv', index=False)

return {
    'original_rows': len(df),
    'cleaned_rows': len(df_clean)
}
""")

        # 3. ç»§ç»­åˆ†æï¼ˆè‡ªåŠ¨å¤ç”¨åŒä¸€ sessionï¼‰
        # ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šå¤ç”¨ sessionï¼ˆ10-50msï¼‰âš¡ï¸
        result2 = await self.session.execute("""
import pandas as pd

df = pd.read_csv('/workspace/data_clean.csv')
stats = df.describe()

return {
    'statistics': stats.to_dict(),
    'dtypes': df.dtypes.astype(str).to_dict()
}
""")

        # 4. ç”Ÿæˆå›¾è¡¨ï¼ˆç»§ç»­å¤ç”¨ sessionï¼‰
        # ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼šå¤ç”¨ sessionï¼ˆ10-50msï¼‰âš¡ï¸
        result3 = await self.session.execute("""
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import pandas as pd

df = pd.read_csv('/workspace/data_clean.csv')
df.plot(kind='bar')
plt.tight_layout()
plt.savefig('/workspace/chart.png', dpi=150)

return {'chart_file': 'chart.png'}
""")

        # 5. ä¸‹è½½å›¾è¡¨
        chart_url = await self._get_file_url("chart.png")

        return {
            "statistics": result2["return_value"],
            "chart_url": chart_url
        }

    async def close(self):
        """å…³é—­ Agentï¼šé”€æ¯ session"""
        await self.session.cleanup()

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    # åˆ›å»º Agent
    agent = DataAnalysisAgent(agent_id="agent_123")

    # æ‰§è¡Œåˆ†æï¼ˆè‡ªåŠ¨ session ç®¡ç†ï¼‰
    result = await agent.analyze_csv("data.csv")
    print(result)

    # å…³é—­ Agentï¼ˆé”€æ¯ sessionï¼‰
    await agent.close()
```

#### 2.2.4 Session é¢„çƒ­ç­–ç•¥

**æå‰åˆå§‹åŒ–**ï¼šAgent å¯ä»¥åœ¨é€‚å½“æ—¶æœºæå‰åˆ›å»º sessionï¼Œå®ç°é›¶å»¶è¿Ÿå¯åŠ¨ä½“éªŒã€‚

```python
class SandboxSession:
    """Agent ä¾§çš„ä¼šè¯ç®¡ç†å™¨ï¼ˆæ”¯æŒé¢„çƒ­ï¼‰"""

    # ... ä¹‹å‰çš„ä»£ç  ...

    async def warmup(self):
        """
        é¢„çƒ­ sessionï¼ˆæå‰åˆå§‹åŒ–ï¼‰

        ä½¿ç”¨åœºæ™¯ï¼š
        1. ç”¨æˆ·ç™»å½•åç«‹å³é¢„çƒ­ï¼Œå‡†å¤‡å¥½æ‰§è¡Œç¯å¢ƒ
        2. ç”¨æˆ·åˆ‡æ¢åˆ°æ•°æ®åˆ†æåŠŸèƒ½æ—¶é¢„çƒ­
        3. å®šæ—¶ä»»åŠ¡é¢„çƒ­é«˜å³°æœŸä¼šè¯
        """
        if not self.session_id:
            logger.info("ğŸ”¥ Warming up session...")
            await self.ensure_session()
            logger.info(f"âœ… Session warmed up and ready: {self.session_id}")
        else:
            logger.info(f"â™»ï¸ Session already exists: {self.session_id}")

    async def ensure_session(self) -> str:
        """ç¡®ä¿ session å­˜åœ¨ï¼ˆå¤ç”¨æˆ–åˆ›å»ºï¼‰"""
        # ... ä¹‹å‰çš„ä»£ç  ...
```

**é¢„çƒ­æ—¶æœºç¤ºä¾‹**ï¼š

```python
class AgentOrchestrator:
    """Agent ç¼–æ’å™¨ï¼šç®¡ç† session ç”Ÿå‘½å‘¨æœŸ"""

    def __init__(self):
        self.session: Optional[SandboxSession] = None

    async def on_user_login(self, user_id: str):
        """ç”¨æˆ·ç™»å½•æ—¶ï¼šé¢„çƒ­ session"""
        self.session = SandboxSession(template_id="python-datascience")
        await self.session.warmup()
        logger.info(f"âœ… Session pre-warmed for user {user_id}")

    async def on_switch_to_data_analysis(self):
        """ç”¨æˆ·åˆ‡æ¢åˆ°æ•°æ®åˆ†æåŠŸèƒ½æ—¶ï¼šé¢„çƒ­ session"""
        if not self.session:
            self.session = SandboxSession(template_id="python-datascience")
            await self.session.warmup()
            logger.info("âœ… Session pre-warmed for data analysis")

    async def execute_user_code(self, code: str) -> dict:
        """æ‰§è¡Œç”¨æˆ·ä»£ç ï¼ˆsession å·²é¢„çƒ­ï¼Œé›¶å»¶è¿Ÿï¼‰"""
        # session å·²åœ¨ç™»å½•æ—¶é¢„çƒ­ï¼Œç›´æ¥æ‰§è¡Œ
        return await self.session.execute(code)

    async def on_user_logout(self):
        """ç”¨æˆ·ç™»å‡ºæ—¶ï¼šæ¸…ç† session"""
        if self.session:
            await self.session.cleanup()
            logger.info("ğŸ—‘ï¸ Session cleaned up on logout")
```

**é¢„çƒ­ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | è§¦å‘æ—¶æœº | é¦–æ¬¡æ‰§è¡Œå»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|------|---------|-------------|---------|
| **Lazyï¼ˆæŒ‰éœ€åˆ›å»ºï¼‰** | ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ | 2-5s | ä½é¢‘ä½¿ç”¨ç”¨æˆ· |
| **Eagerï¼ˆç™»å½•é¢„çƒ­ï¼‰** | ç”¨æˆ·ç™»å½•å | **0msï¼ˆé›¶å»¶è¿Ÿï¼‰** | é«˜é¢‘ä½¿ç”¨ï¼Œä½“éªŒä¼˜å…ˆ |
| **åŠŸèƒ½åˆ‡æ¢é¢„çƒ­** | è¿›å…¥ç‰¹å®šåŠŸèƒ½æ—¶ | **0msï¼ˆé›¶å»¶è¿Ÿï¼‰** | æ•°æ®åˆ†æç­‰é‡åŠŸèƒ½ |
| **å®šæ—¶é¢„çƒ­** | é«˜å³°æœŸå‰æ‰¹é‡é¢„çƒ­ | **0msï¼ˆé›¶å»¶è¿Ÿï¼‰** | å¯é¢„æµ‹çš„é«˜å³°æœŸ |

**å®Œæ•´ä½¿ç”¨æµç¨‹**ï¼š

```python
# åœºæ™¯ï¼šç”¨æˆ·ç™»å½•åçš„å®Œæ•´æµç¨‹

async def user_login_flow(user_id: str):
    orchestrator = AgentOrchestrator()

    # 1. ç”¨æˆ·ç™»å½• â†’ ç«‹å³é¢„çƒ­ sessionï¼ˆ2-5sï¼Œåå°æ‰§è¡Œï¼‰
    await orchestrator.on_user_login(user_id)
    # æ­¤æ—¶ session å·²å‡†å¤‡å¥½

    # 2. ç”¨æˆ·æµè§ˆå…¶ä»–åŠŸèƒ½ï¼ˆsession ä¿æŒæ´»è·ƒï¼‰
    await asyncio.sleep(300)  # ç”¨æˆ·æµè§ˆ 5 åˆ†é’Ÿ

    # 3. ç”¨æˆ·å¼€å§‹æ•°æ®åˆ†æ â†’ é›¶å»¶è¿Ÿæ‰§è¡Œ
    result = await orchestrator.execute_user_code("""
import pandas as pd
# ... ç”¨æˆ·ä»£ç 
""")
    # âš¡ï¸ ç«‹å³æ‰§è¡Œï¼Œæ— éœ€ç­‰å¾… session åˆ›å»º

    # 4. ç”¨æˆ·ç™»å‡º â†’ æ¸…ç† session
    await orchestrator.on_user_logout()
```

**ä¼˜åŠ¿**ï¼š
1. **é›¶å»¶è¿Ÿä½“éªŒ**ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡æ‰§è¡Œä»£ç æ—¶ session å·²å‡†å¤‡å¥½
2. **èµ„æºå¯æ§**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶ä½•æ—¶é¢„çƒ­ï¼Œé¿å…èµ„æºæµªè´¹
3. **çµæ´»è°ƒåº¦**ï¼šAgent æ ¹æ®ä¸šåŠ¡é€»è¾‘å†³å®šé¢„çƒ­æ—¶æœº
4. **ç”¨æˆ·ä½“éªŒ**ï¼šå¯¹äºé«˜é¢‘åŠŸèƒ½ï¼Œæä¾›å³æ—¶å“åº”

#### 2.2.5 å¤šä¸ª Agent çš„åœºæ™¯

```python
# åœºæ™¯ï¼šå¤šä¸ªç”¨æˆ·å„è‡ªä½¿ç”¨ Agentï¼Œæ¯ä¸ª Agent æœ‰ç‹¬ç«‹çš„ session
class MultiAgentManager:
    """å¤š Agent ç®¡ç†å™¨"""

    def __init__(self):
        # æ¯ä¸ª Agent æœ‰ç‹¬ç«‹çš„ session
        self.agents: Dict[str, SandboxSession] = {}

    def get_agent_session(self, agent_id: str) -> SandboxSession:
        """è·å– Agent çš„ sessionï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
        if agent_id not in self.agents:
            # ä¸ºæ–° Agent åˆ›å»º session
            self.agents[agent_id] = SandboxSession(
                template_id="python-datascience"
            )
        return self.agents[agent_id]

    async def execute_for_agent(
        self,
        agent_id: str,
        code: str
    ) -> dict:
        """ä¸ºæŒ‡å®š Agent æ‰§è¡Œä»£ç """
        session = self.get_agent_session(agent_id)
        return await session.execute(code)

    async def cleanup_agent(self, agent_id: str):
        """æ¸…ç† Agent çš„ session"""
        if agent_id in self.agents:
            await self.agents[agent_id].cleanup()
            del self.agents[agent_id]

# ä½¿ç”¨ç¤ºä¾‹
manager = MultiAgentManager()

# Agent A æ‰§è¡Œä»£ç ï¼ˆåˆ›å»º session_aï¼‰
result_a1 = await manager.execute_for_agent("agent_a", "print('Agent A')")
result_a2 = await manager.execute_for_agent("agent_a", "print('Agent A again')")  # å¤ç”¨ session_a

# Agent B æ‰§è¡Œä»£ç ï¼ˆåˆ›å»º session_bï¼‰
result_b = await manager.execute_for_agent("agent_b", "print('Agent B')")  # ç‹¬ç«‹çš„ session_b

# æ¸…ç† Agent A
await manager.cleanup_agent("agent_a")
```

#### 2.2.6 æ²™ç®±å¹³å° APIï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
# æ²™ç®±å¹³å°åªéœ€æä¾›åŸºç¡€ APIï¼Œæ— éœ€çŸ¥é“ Agent æ¦‚å¿µ

# 1. åˆ›å»º session
POST /api/v1/sessions
Request: {"template_id": "python-datascience", "timeout": 3600}
Response: {"session_id": "sess_123", "status": "running"}

# 2. æ‰§è¡Œä»£ç ï¼ˆæŒ‡å®š session_idï¼‰
POST /api/v1/sessions/{session_id}/execute
Request: {"code": "...", "language": "python", "timeout": 300}
Response: {"execution_id": "exec_456", "status": "submitted"}

# 3. æŸ¥è¯¢æ‰§è¡Œç»“æœ
GET /api/v1/executions/{execution_id}/result
Response: {"status": "completed", "return_value": {...}, "stdout": "..."}

# 4. æŸ¥è¯¢ session çŠ¶æ€
GET /api/v1/sessions/{session_id}
Response: {"session_id": "sess_123", "status": "running", "last_activity_at": "..."}

# 5. é”€æ¯ session
DELETE /api/v1/sessions/{session_id}
Response: {"status": "terminated"}
```

#### 2.2.7 å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | Agent ä¾§ | æ²™ç®±å¹³å°ä¾§ |
|------|---------|-----------|
| **Session åˆ›å»º** | Agent å†³å®šä½•æ—¶åˆ›å»ºï¼ˆæ”¯æŒé¢„çƒ­ï¼‰ | æä¾› APIï¼Œæ— çŠ¶æ€ |
| **Session å¤ç”¨** | Agent ç»´æŠ¤ session_id å¹¶å¤ç”¨ | æ— éœ€çŸ¥é“å¤ç”¨é€»è¾‘ |
| **Session é¢„çƒ­** | Agent åœ¨é€‚å½“æ—¶æœºæå‰åˆå§‹åŒ– | æ— éœ€çŸ¥é“é¢„çƒ­é€»è¾‘ |
| **Session é”€æ¯** | Agent å†³å®šä½•æ—¶é”€æ¯ | æä¾› APIï¼Œæ— çŠ¶æ€ |
| **Agent æ¦‚å¿µ** | Agent çŸ¥é“è‡ªå·±çš„ session | æ— éœ€çŸ¥é“ Agent æ¦‚å¿µ |
| **è°ƒåº¦ç­–ç•¥** | Agent é€šè¿‡å¤ç”¨ session_id å®ç° | åŸºç¡€è°ƒåº¦ï¼ˆæ¨¡æ¿äº²å’Œã€é¢„çƒ­æ± ã€è´Ÿè½½å‡è¡¡ï¼‰ |

**æ€§èƒ½å¯¹æ¯”**ï¼š

| è°ƒåº¦æ–¹å¼ | å»¶è¿Ÿ | è´Ÿè´£æ–¹ | ä½¿ç”¨åœºæ™¯ |
|---------|------|-------|---------|
| Agent å¤ç”¨ session_id | **10-50ms**ï¼ˆæœ€å¿«ï¼‰ | Agent ä¾§ | Agent å¤šæ¬¡æ‰§è¡Œ |
| Agent æå‰é¢„çƒ­ | **0msï¼ˆé›¶å»¶è¿Ÿï¼‰** | Agent ä¾§ | ç”¨æˆ·ç™»å½•åé¢„çƒ­ |
| æ²™ç®±æ¨¡æ¿äº²å’Œæ€§è°ƒåº¦ | 1-2s | æ²™ç®±å¹³å°ä¾§ | å®¹å™¨å·²å­˜åœ¨ |
| æ²™ç®±é¢„çƒ­æ±  | 100-500ms | æ²™ç®±å¹³å°ä¾§ | å¸¸ç”¨æ¨¡æ¿é¢„çƒ­ |
| å†·å¯åŠ¨ | 2-5s | æ²™ç®±å¹³å°ä¾§ | æ–°ä¼šè¯åˆ›å»º |

---

## 3. ç«¯åˆ°ç«¯æµç¨‹è®¾è®¡

### 3.1 åœºæ™¯ä¸€ï¼šPTC æ•°æ®åˆ†æ - Agent ä»£ç ç”Ÿæˆä¸æ‰§è¡Œå¾ªç¯

#### 3.1.1 åœºæ™¯æè¿°

**ç”¨æˆ·éœ€æ±‚**ï¼šç”¨æˆ·ä¸Šä¼  CSV æ•°æ®æ–‡ä»¶ï¼Œè¦æ±‚ AI Agent è¿›è¡Œæ•°æ®æ¸…æ´—ã€ç»Ÿè®¡åˆ†æã€ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ã€‚

**æµç¨‹ç‰¹ç‚¹**ï¼š
- Agent è‡ªä¸»ç”Ÿæˆä»£ç ï¼ˆä¸æ˜¯ç”¨æˆ·ç›´æ¥ç¼–å†™ï¼‰
- å¤šè½®è¿­ä»£æ‰§è¡Œï¼ˆæ•°æ®åŠ è½½ â†’ æ¸…æ´— â†’ åˆ†æ â†’ å¯è§†åŒ–ï¼‰
- æ¯è½®ç»“æœè¿”å›ç»™ Agent è¿›è¡Œä¸‹ä¸€æ­¥æ¨ç†
- ä¸­é—´ç»“æœéœ€è¦æŒä¹…åŒ–ï¼ˆæ¸…æ´—åçš„æ•°æ®ã€ç”Ÿæˆçš„å›¾è¡¨ï¼‰
- Agent ç»´æŠ¤ session_id å®ç°ä¼šè¯å¤ç”¨ï¼ˆæ— éœ€æ‰‹åŠ¨ç®¡ç†ï¼‰
- æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼ˆå¯èƒ½è¶…è¿‡ 30 ç§’ï¼‰

**å…³é”®ç‚¹**ï¼š
- **Agent æ˜¯ä»£ç çš„ç”Ÿæˆè€…**ï¼Œä¸æ˜¯ç”¨æˆ·ç›´æ¥å†™ä»£ç 
- **æ²™ç®±æ˜¯å·¥å…·**ï¼Œè¢« Agent é€šè¿‡ç¨‹åºåŒ–æ¥å£è°ƒç”¨
- **ç»“æœæ˜¯æ¨ç†çš„è¾“å…¥**ï¼Œè¿”å›ç»™ Agent ç”¨äºç”Ÿæˆä¸‹ä¸€æ­¥ä»£ç 
- **Agent è´Ÿè´£ä¼šè¯ç®¡ç†**ï¼Œæ²™ç®±å¹³å°æä¾›ç»Ÿä¸€æ‰§è¡Œèƒ½åŠ›

#### 3.1.2 å®Œæ•´äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant Agent as ğŸ¤– Data Agent
    participant API as ğŸŒ Control Plane API
    participant Scheduler as âš™ï¸ è°ƒåº¦å™¨
    participant Session as ğŸ“¦ Session Manager
    participant Runtime as ğŸ³ Runtime
    participant Executor as âš¡ sandbox-executor
    participant S3 as ğŸ“¦ S3 Storage
    participant DB as ğŸ’¾ MariaDB

    Note over User,DB: é˜¶æ®µ 1: Agent åˆ›å»º sessionï¼ˆå¹¶ç»´æŠ¤ session_idï¼‰
    User->>Agent: ä¸Šä¼  CSV æ–‡ä»¶ + åˆ†æéœ€æ±‚
    Agent->>API: POST /api/v1/sessions<br/>{template_id: "python-datascience", timeout: 3600}
    API->>Session: create_session()
    Session->>Scheduler: schedule()
    Scheduler->>Runtime: è·å–/åˆ›å»ºå®¹å™¨ï¼ˆæŒ‚è½½ S3 workspaceï¼‰
    Runtime->>S3: åˆ›å»º workspace å·
    Runtime-->>Session: è¿”å› container_id
    Session->>DB: ä¿å­˜ä¼šè¯è®°å½•ï¼ˆstatus=runningï¼‰
    Session-->>API: è¿”å› session_id
    API-->>Agent: è¿”å› session_idï¼ˆAgent ç¼“å­˜æ­¤ IDï¼‰

    Note over User,DB: é˜¶æ®µ 2: æ–‡ä»¶ä¸Šä¼ åˆ° workspace
    Agent->>API: POST /api/v1/sessions/{id}/files/upload<br/>upload: data.csv
    API->>S3: ä¸Šä¼ æ–‡ä»¶åˆ° s3://bucket/sessions/{id}/data.csv
    API-->>Agent: æ–‡ä»¶ä¸Šä¼ æˆåŠŸ

    Note over User,DB: é˜¶æ®µ 3: æ‰§è¡Œæ­¥éª¤ 1 - æ•°æ®åŠ è½½ä¸æ¸…æ´—
    Agent->>API: POST /api/v1/sessions/{id}/execute<br/>{code: "import pandas as pd\ndf = pd.read_csv('/workspace/data.csv')\ndf_clean = df.dropna()\ndf_clean.to_csv('/workspace/data_clean.csv', index=False)\nreturn {'rows': len(df_clean), 'cols': len(df_clean.columns)}"}
    API->>DB: åˆ›å»º execution è®°å½•ï¼ˆstatus=pendingï¼‰
    API->>Runtime: é€šè¿‡å®¹å™¨å†… HTTP API å‘é€æ‰§è¡Œè¯·æ±‚
    Runtime->>Executor: POST /executeï¼ˆå®¹å™¨å·²å¯åŠ¨ï¼‰
    Executor->>Executor: bwrap éš”ç¦»æ‰§è¡Œ Python ä»£ç 
    Executor->>S3: å†™å…¥ data_clean.csv åˆ° workspace
    Executor->>Executor: æ”¶é›† stdout/stderr/è¿”å›å€¼
    Executor->>API: POST /internal/executions/{eid}/result<br/>{status: "success", return_value: {...}, artifacts: ["data_clean.csv"]}
    API->>DB: æ›´æ–° execution çŠ¶æ€ï¼ˆstatus=completedï¼‰
    API-->>Agent: è¿”å› execution_id
    Agent->>API: GET /api/v1/executions/{eid}/result
    API->>DB: æŸ¥è¯¢æ‰§è¡Œç»“æœ
    API-->>Agent: è¿”å›ç»“æœï¼ˆåŒ…å« return_value å’Œ artifactsï¼‰

    Note over User,DB: é˜¶æ®µ 4: æ‰§è¡Œæ­¥éª¤ 2 - ç»Ÿè®¡åˆ†æï¼ˆAgent å¤ç”¨åŒä¸€ session_idï¼‰
    Agent->>API: POST /api/v1/sessions/{id}/execute<br/>{code: "import pandas as pd\ndf = pd.read_csv('/workspace/data_clean.csv')\nstats = df.describe()\nreturn {'mean': stats.mean().to_dict(), 'std': stats.std().to_dict()}"}
    API->>Runtime: Agent æŒ‡å®š session_idï¼Œå¤ç”¨åŒä¸€å®¹å™¨ï¼ˆçƒ­å¯åŠ¨ï¼Œ< 50msï¼‰
    Runtime->>Executor: POST /execute
    Executor->>S3: è¯»å– data_clean.csv
    Executor->>Executor: æ‰§è¡Œç»Ÿè®¡åˆ†æ
    Executor->>API: ä¸ŠæŠ¥ç»“æœ
    API-->>Agent: è¿”å›ç»Ÿè®¡ç»“æœ

    Note over User,DB: é˜¶æ®µ 5: æ‰§è¡Œæ­¥éª¤ 3 - ç”Ÿæˆå¯è§†åŒ–ï¼ˆAgent å¤ç”¨åŒä¸€ session_idï¼‰
    Agent->>API: POST /api/v1/sessions/{id}/execute<br/>{code: "import matplotlib.pyplot as plt\nimport pandas as pd\ndf = pd.read_csv('/workspace/data_clean.csv')\ndf.plot(kind='bar')\nplt.savefig('/workspace/chart.png')\nreturn {'chart': 'chart.png'}"}
    API->>Runtime: Agent æŒ‡å®š session_idï¼Œå¤ç”¨åŒä¸€å®¹å™¨
    Runtime->>Executor: POST /execute
    Executor->>S3: ä¿å­˜ chart.png åˆ° workspace
    Executor->>API: ä¸ŠæŠ¥ç»“æœï¼ˆartifacts: ["chart.png"]ï¼‰
    API-->>Agent: è¿”å›æ‰§è¡Œç»“æœï¼ˆåŒ…å«å›¾è¡¨æ–‡ä»¶ï¼‰

    Note over User,DB: é˜¶æ®µ 6: æ–‡ä»¶ä¸‹è½½
    Agent->>API: GET /api/v1/sessions/{id}/files/chart.png
    API->>S3: ç”Ÿæˆé¢„ç­¾å URL
    API-->>Agent: è¿”å›ä¸‹è½½é“¾æ¥
    Agent-->>User: å±•ç¤ºåˆ†æç»“æœå’Œå›¾è¡¨

    Note over User,DB: é˜¶æ®µ 7: ä¼šè¯æ¸…ç†ï¼ˆç”¨æˆ·å®Œæˆåˆ†ææˆ–è¶…æ—¶ï¼‰
    Agent->>API: DELETE /api/v1/sessions/{id}
    API->>Session: terminate_session()
    Session->>Runtime: é”€æ¯å®¹å™¨
    Runtime->>S3: ä¿ç•™ workspace æ–‡ä»¶ï¼ˆæ ¹æ®ä¿ç•™ç­–ç•¥ï¼‰
    Session->>DB: æ›´æ–°ä¼šè¯çŠ¶æ€ï¼ˆstatus=terminatedï¼‰
    API-->>Agent: ä¼šè¯å·²ç»ˆæ­¢
```

#### 3.1.3 å…³é”®ä»£ç å®ç°

**1. Agent åˆ›å»º sessionï¼ˆå¹¶ç»´æŠ¤ session_idï¼‰**

```python
# Agent ä¾§ï¼šåˆ›å»º session å¹¶ç¼“å­˜ session_id
async def create_session():
    response = await http_client.post(
        f"{SANDBOX_API}/api/v1/sessions",
        json={
            "template_id": "python-datascience",  # åŒ…å« pandas/numpy/matplotlib
            "timeout": 3600,  # 1 å°æ—¶è¶…æ—¶
            "resources": {
                "cpu": "2",
                "memory": "2Gi",
                "disk": "5Gi"
            },
            "env_vars": {
                "PYTHONPATH": "/workspace"
            }
        }
    )
    return response.json()["session_id"]  # Agent ç¼“å­˜æ­¤ ID
```

**2. æ–‡ä»¶ä¸Šä¼ **

```python
async def upload_file_to_session(session_id: str, file_path: str):
    """ä¸Šä¼ æ–‡ä»¶åˆ°ä¼šè¯ workspace"""
    async with httpx.AsyncClient() as client:
        with open(file_path, "rb") as f:
            files = {"file": f}
            response = await client.post(
                f"{SANDBOX_API}/api/v1/sessions/{session_id}/files/upload",
                files=files
            )
    return response.json()
```

**3. æ‰§è¡Œä»£ç ï¼ˆAgent æŒ‡å®š session_idï¼‰**

```python
async def execute_in_session(session_id: str, code: str):
    """åœ¨æŒ‡å®š session ä¸­æ‰§è¡Œä»£ç ï¼ˆAgent æä¾› session_idï¼‰"""
    response = await http_client.post(
        f"{SANDBOX_API}/api/v1/sessions/{session_id}/execute",
        json={
            "code": code,
            "language": "python",
            "timeout": 300
        }
    )
    execution_id = response.json()["execution_id"]

    # è½®è¯¢ç­‰å¾…ç»“æœ
    while True:
        result = await http_client.get(
            f"{SANDBOX_API}/api/v1/executions/{execution_id}/result"
        )
        data = result.json()
        if data["status"] in ["completed", "failed", "timeout"]:
            return data
        await asyncio.sleep(0.5)
```

**4. Agent å®Œæ•´ä½¿ç”¨ç¤ºä¾‹**

```python
class DataAnalysisAgent:
    """PTC æ•°æ®åˆ†æ Agent"""

    def __init__(self):
        self.session_id = None  # Agent ç»´æŠ¤ session_id
        self.api_base = os.environ["SANDBOX_API"]

    async def analyze_csv(self, csv_file_path: str):
        # 1. Agent åˆ›å»º sessionï¼ˆå¹¶ç¼“å­˜ session_idï¼‰
        self.session_id = await self._create_session()
        print(f"âœ… Session created: {self.session_id}")

        # 2. ä¸Šä¼ æ–‡ä»¶
        await self._upload_file(csv_file_path)
        print(f"âœ… File uploaded: {csv_file_path}")

        # 3. æ•°æ®æ¸…æ´—
        clean_code = """
import pandas as pd

# è¯»å–æ•°æ®
df = pd.read_csv('/workspace/data.csv')

# æ•°æ®æ¸…æ´—
df_clean = df.dropna()
df_clean = df_clean.drop_duplicates()

# ä¿å­˜ä¸­é—´ç»“æœ
df_clean.to_csv('/workspace/data_clean.csv', index=False)

return {
    'original_rows': len(df),
    'cleaned_rows': len(df_clean),
    'columns': list(df_clean.columns)
}
"""
        clean_result = await self._execute(clean_code)
        print(f"âœ… Data cleaned: {clean_result['return_value']}")

        # 4. ç»Ÿè®¡åˆ†æ
        stats_code = """
import pandas as pd

df = pd.read_csv('/workspace/data_clean.csv')
stats = df.describe()

return {
    'statistics': stats.to_dict(),
    'dtypes': df.dtypes.astype(str).to_dict()
}
"""
        stats_result = await self._execute(stats_code)
        print(f"âœ… Statistics computed")

        # 5. ç”Ÿæˆå›¾è¡¨
        chart_code = """
import matplotlib
matplotlib.use('Agg')  # æ—  GUI åç«¯
import matplotlib.pyplot as plt
import pandas as pd

df = pd.read_csv('/workspace/data_clean.csv')

# ç”ŸæˆæŸ±çŠ¶å›¾
df.plot(kind='bar')
plt.tight_layout()
plt.savefig('/workspace/chart.png', dpi=150)

return {
    'chart_file': 'chart.png',
    'size_bytes': None  # å°†åœ¨æ‰§è¡Œåå¡«å……
}
"""
        chart_result = await self._execute(chart_code)
        print(f"âœ… Chart generated: {chart_result['artifacts']}")

        # 6. ä¸‹è½½å›¾è¡¨
        chart_url = await self._get_file_url("chart.png")
        print(f"âœ… Chart URL: {chart_url}")

        # 7. æ¸…ç†ä¼šè¯
        await self._terminate_session()
        print(f"âœ… Session terminated")

        return {
            "statistics": stats_result["return_value"],
            "chart_url": chart_url
        }
```

#### 3.1.4 æ€§èƒ½æŒ‡æ ‡éªŒè¯

| æ“ä½œ | é¢„æœŸæ€§èƒ½ | éªŒè¯æ–¹æ³• |
|------|---------|---------|
| å†·å¯åŠ¨åˆ›å»ºä¼šè¯ | < 5s | è®¡æ—¶å™¨æµ‹é‡ä» API è°ƒç”¨åˆ°å®¹å™¨å°±ç»ª |
| çƒ­å¯åŠ¨æ‰§è¡Œä»£ç  | < 100ms | å¤ç”¨ä¼šè¯æ—¶çš„ API å»¶è¿Ÿ |
| æ–‡ä»¶ä¸Šä¼  (10MB) | < 2s | ç›´ä¼  S3ï¼ŒAPI é€ä¼  |
| æ•°æ®åŠ è½½ (100MB CSV) | < 3s | pandas è¯»å–æ€§èƒ½ |
| ç”Ÿæˆå›¾è¡¨ (1000 æ•°æ®ç‚¹) | < 2s | matplotlib æ¸²æŸ“æ€§èƒ½ |
| å†…å­˜å ç”¨ | < 2Gi | å®¹å™¨èµ„æºç›‘æ§ |
| CPU å³°å€¼ | < 2 cores | å®¹å™¨èµ„æºç›‘æ§ |

---

### 3.2 åœºæ™¯äºŒï¼šé PTC é—®ç­” - Agent æ–‡ä»¶ä¸Šä¼ ä¸å¤šè½®è¯»å–

#### 3.2.1 åœºæ™¯æè¿°

**ç”¨æˆ·éœ€æ±‚**ï¼šç”¨æˆ·ä¸Šä¼  PDF æ–‡æ¡£ï¼Œè¦æ±‚ AI Agent åŸºäºæ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜ã€‚

**æµç¨‹ç‰¹ç‚¹**ï¼š
- Agent è°ƒç”¨æ–‡ä»¶ä¸Šä¼ å·¥å…·ï¼ˆç”¨æˆ·è§¦å‘ä¸Šä¼ ï¼‰
- æ–‡ä»¶å­˜å‚¨åˆ°æ²™ç®± workspaceï¼ˆæŒä¹…åŒ–ï¼‰
- Agent å¤šæ¬¡è°ƒç”¨ä»£ç è¯»å–åŒä¸€æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†
- æ¯æ¬¡è¯»å–ç»“æœè¿”å›ç»™ Agent è¿›è¡Œæ¨ç†
- Agent ç»´æŠ¤ session_id å®ç°ä¼šè¯å¤ç”¨
- æ‰§è¡Œæ—¶é—´è¾ƒçŸ­ï¼ˆé€šå¸¸ < 10s æ¯æ¬¡ï¼‰
- æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼ˆPDFã€å›¾ç‰‡ OCRã€CSVã€DOCXï¼‰

**å…³é”®ç‚¹**ï¼š
- **æ–‡ä»¶ä¸€æ¬¡æ€§ä¸Šä¼ **ï¼Œå­˜å‚¨åœ¨ workspace
- **Agent å¤šæ¬¡è¯»å–**ï¼Œæ¯æ¬¡è°ƒç”¨ä»£ç è¯»å–ä¸åŒéƒ¨åˆ†
- **Agent é€šè¿‡å¤ç”¨ session_id**ï¼Œæ–‡ä»¶æŒç»­å¯è®¿é—®
- **å¤šè½®å¯¹è¯æ”¯æŒ**ï¼ŒAgent å¯åå¤å¼•ç”¨æ–‡ä»¶å†…å®¹

#### 3.2.2 å®Œæ•´äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant Agent as ğŸ¤– Data Agent
    participant API as ğŸŒ Control Plane API
    participant Scheduler as âš™ï¸ è°ƒåº¦å™¨
    participant WarmPool as ğŸ”¥ Warm Pool
    participant Runtime as ğŸ³ Runtime
    participant Executor as âš¡ sandbox-executor
    participant S3 as ğŸ“¦ S3 Storage
    participant DB as ğŸ’¾ MariaDB

    Note over User,DB: é˜¶æ®µ 1: æ–‡ä»¶ä¸Šä¼ åˆ° workspace
    User->>Agent: ä¸Šä¼  PDF + æé—®ï¼š"æ–‡æ¡£æ€»ç»“æ˜¯ä»€ä¹ˆï¼Ÿ"
    Agent->>API: POST /api/v1/sessions/{session_id}/files/upload<br/>upload: document.pdf
    Note over Agent: Agent ç»´æŠ¤ session_idï¼Œç›´æ¥æŒ‡å®š

    API->>S3: ä¸Šä¼ æ–‡ä»¶åˆ° s3://bucket/sessions/{session_id}/workspace/document.pdf
    API-->>Agent: æ–‡ä»¶ä¸Šä¼ æˆåŠŸ

    Note over User,DB: é˜¶æ®µ 2: Agent ç¬¬ä¸€æ¬¡è¯»å–æ–‡ä»¶ï¼ˆå‰ 10 é¡µï¼‰
    Agent->>API: POST /api/v1/sessions/{session_id}/execute<br/>{code: "è¯»å– PDF å‰ 10 é¡µå¹¶æå–æ–‡æœ¬"}
    API->>Runtime: Agent æŒ‡å®š session_idï¼Œå¤ç”¨å®¹å™¨âš¡ï¸
    API->>Runtime: åœ¨å®¹å™¨ä¸­æ‰§è¡Œä»£ç 
    Runtime->>Executor: POST /execute
    Executor->>S3: è¯»å– workspace/document.pdf
    Executor->>Executor: pdfplumber è§£æå‰ 10 é¡µ
    Executor->>API: POST /internal/executions/{eid}/result<br/>{status: "success", return_value: {text: "..."}}
    API->>DB: ä¿å­˜æ‰§è¡Œç»“æœ
    API-->>Agent: è¿”å›å‰ 10 é¡µæ–‡æœ¬å†…å®¹

    Note over User,DB: é˜¶æ®µ 3: Agent åˆ†æå‰ 10 é¡µï¼Œç”Ÿæˆç¬¬äºŒæ¬¡è¯»å–è¯·æ±‚
    Agent->>Agent: åˆ†æå‰ 10 é¡µå†…å®¹
    Agent->>API: POST /api/v1/sessions/{session_id}/execute<br/>{code: "è¯»å– PDF ç¬¬ 11-20 é¡µ"}
    API->>Runtime: Agent å¤ç”¨åŒä¸€ session_idâš¡ï¸
    API->>Runtime: åœ¨å®¹å™¨ä¸­æ‰§è¡Œä»£ç 
    Runtime->>Executor: POST /execute
    Executor->>S3: è¯»å– workspace/document.pdf
    Executor->>Executor: pdfplumber è§£æç¬¬ 11-20 é¡µ
    Executor->>API: è¿”å›ç¬¬ 11-20 é¡µæ–‡æœ¬å†…å®¹
    API-->>Agent: è¿”å›ç¬¬ 11-20 é¡µæ–‡æœ¬å†…å®¹

    Note over User,DB: é˜¶æ®µ 4: Agent ç»¼åˆåˆ†æï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
    Agent->>Agent: ç»¼åˆå‰åä¸¤éƒ¨åˆ†å†…å®¹
    Agent->>Agent: ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
    Agent-->>User: è¿”å›ï¼š"æ–‡æ¡£åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‰åŠéƒ¨åˆ†è®²..."

    Note over User,DB: é˜¶æ®µ 5: ä¼šè¯ä¿æŒæ´»è·ƒï¼ˆç­‰å¾…ä¸‹æ¬¡å¯¹è¯ï¼‰
    Note over API,S3: æ–‡ä»¶ä¿ç•™åœ¨ workspaceï¼Œä¼šè¯å¯ç»§ç»­å¤ç”¨
```

#### 3.2.3 å…³é”®ä»£ç å®ç°

**1. æ–‡ä»¶ä¸Šä¼ å·¥å…·ï¼ˆAgent è°ƒç”¨ï¼‰**

```python
class FileUploadTool:
    """æ–‡ä»¶ä¸Šä¼ å·¥å…·ï¼šç”± Agent è°ƒç”¨"""

    async def upload_file(self, agent_id: str, file_path: str) -> dict:
        """
        ä¸Šä¼ æ–‡ä»¶åˆ° Agent çš„æ²™ç®± workspace

        Args:
            agent_id: Agent IDï¼ˆç”¨äºä¼šè¯å¤ç”¨ï¼‰
            file_path: æœ¬åœ°æ–‡ä»¶è·¯å¾„

        Returns:
            {
                "file_id": "file_abc123",
                "session_id": "sess_xyz",
                "workspace_path": "/workspace/document.pdf",
                "status": "uploaded"
            }
        """
        # è°ƒç”¨æ²™ç®±å¹³å° API
        async with httpx.AsyncClient() as client:
            with open(file_path, "rb") as f:
                files = {"file": (os.path.basename(file_path), f)}
                response = await client.post(
                    f"{SANDBOX_API}/api/v1/agents/{agent_id}/files/upload",
                    files=files
                )

        result = response.json()

        # å¹³å°ä¼šè‡ªåŠ¨ï¼š
        # 1. æ£€æŸ¥ Agent æ˜¯å¦å·²æœ‰æ´»è·ƒä¼šè¯
        # 2. å¦‚æœæœ‰ï¼Œå¤ç”¨è¯¥ä¼šè¯ï¼ˆæœ€å¿«ï¼š10-50msï¼‰
        # 3. å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–°ä¼šè¯ï¼ˆå†·å¯åŠ¨ï¼š2-5sï¼‰
        # 4. æ–‡ä»¶å­˜å‚¨åˆ° workspace çš„ S3 å·

        return result
```

**2. æ–‡ä»¶è¯»å–ä»£ç ï¼ˆAgent ç”Ÿæˆï¼‰**

```python
# Agent ç”Ÿæˆçš„ä»£ç ï¼šè¯»å– PDF ç¬¬ N-M é¡µ
READ_PAGES_CODE_TEMPLATE = """
import json
from pdfplumber import PDF

def handler(event):
    '''è¯»å– PDF æŒ‡å®šé¡µç èŒƒå›´'''
    file_path = event.get('file_path', '/workspace/document.pdf')
    start_page = event.get('start_page', 1)
    end_page = event.get('end_page', 10)

    with PDF(file_path) as pdf:
        pages = []

        for i, page in enumerate(pdf.pages):
            if i + 1 < start_page:
                continue
            if i + 1 > end_page:
                break

            text = page.extract_text()
            pages.append({{
                'page_num': i + 1,
                'text': text
            }})

    return {{
        'total_pages': len(pdf.pages),
        'read_pages': len(pages),
        'content': pages
    }}
"""

# Agent ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šè¯»å–å‰ 10 é¡µ
first_call_code = READ_PAGES_CODE_TEMPLATE
first_call_event = {
    "file_path": "/workspace/document.pdf",
    "start_page": 1,
    "end_page": 10
}

# Agent ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šè¯»å–ç¬¬ 11-20 é¡µï¼ˆå¤ç”¨åŒä¸€ä¼šè¯ï¼‰
second_call_code = READ_PAGES_CODE_TEMPLATE
second_call_event = {
    "file_path": "/workspace/document.pdf",
    "start_page": 11,
    "end_page": 20
}
```

**3. Agent å·¥å…·å±‚å°è£…**

```python
class SandboxFileTool:
    """æ²™ç®±æ–‡ä»¶å·¥å…·ï¼šæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œå¤šè½®è¯»å–"""

    def __init__(self, agent_id: str):
        self.agent_id = agent_id
        self.api_base = os.environ["SANDBOX_API"]

    async def upload_file(self, file_path: str) -> dict:
        """ä¸Šä¼ æ–‡ä»¶åˆ° workspace"""
        async with httpx.AsyncClient() as client:
            with open(file_path, "rb") as f:
                files = {"file": (os.path.basename(file_path), f)}
                response = await client.post(
                    f"{self.api_base}/api/v1/agents/{self.agent_id}/files/upload",
                    files=files
                )
        return response.json()

    async def read_pdf_pages(
        self,
        file_path: str,
        start_page: int = 1,
        end_page: int = 10
    ) -> dict:
        """
        è¯»å– PDF æŒ‡å®šé¡µç èŒƒå›´

        æ³¨æ„ï¼šä¼šè‡ªåŠ¨å¤ç”¨ Agent çš„ä¼šè¯ï¼Œæ–‡ä»¶å·²å­˜åœ¨äº workspace
        """
        code = f"""
from pdfplumber import PDF

with PDF('{file_path}') as pdf:
    pages = []
    for i, page in enumerate(pdf.pages):
        if i + 1 < {start_page}:
            continue
        if i + 1 > {end_page}:
            break
        pages.append({{ 'page_num': i + 1, 'text': page.extract_text() }})

    return {{
        'total_pages': len(pdf.pages),
        'read_pages': len(pages),
        'content': pages
    }}
"""

        # è°ƒç”¨æ²™ç®±æ‰§è¡Œ APIï¼ˆåŒæ­¥ç­‰å¾…ï¼‰
        result = await self._execute_sync(code)
        return result["return_value"]

    async def _execute_sync(self, code: str, timeout: int = 60):
        """åŒæ­¥æ‰§è¡Œä»£ç ï¼ˆå·¥å…·å±‚å°è£…ï¼‰"""
        response = await http_client.post(
            f"{self.api_base}/api/v1/agents/{self.agent_id}/execute",
            json={"code": code, "timeout": timeout}
        )
        execution_id = response.json()["execution_id"]

        # è½®è¯¢ç­‰å¾…ç»“æœ
        while True:
            result_response = await http_client.get(
                f"{self.api_base}/api/v1/executions/{execution_id}/result"
            )
            result = result_response.json()

            if result["status"] in ["completed", "failed", "timeout"]:
                return result

            await asyncio.sleep(0.5)

# Agent ä½¿ç”¨ç¤ºä¾‹
tool = SandboxFileTool(agent_id="agent_abc123")

# 1. ä¸Šä¼ æ–‡ä»¶
upload_result = await tool.upload_file("document.pdf")
print(f"âœ… File uploaded: {upload_result['workspace_path']}")

# 2. ç¬¬ä¸€æ¬¡è¯»å–ï¼ˆå‰ 10 é¡µï¼‰- å¤ç”¨ä¼šè¯
pages_1_10 = await tool.read_pdf_pages("/workspace/document.pdf", 1, 10)
print(f"âœ… Read pages 1-10: {pages_1_10['read_pages']} pages")

# 3. ç¬¬äºŒæ¬¡è¯»å–ï¼ˆç¬¬ 11-20 é¡µï¼‰- å¤ç”¨ä¼šè¯ï¼ˆ10-50msï¼‰âš¡ï¸
pages_11_20 = await tool.read_pdf_pages("/workspace/document.pdf", 11, 20)
print(f"âœ… Read pages 11-20: {pages_11_20['read_pages']} pages")
```

**4. å®Œæ•´çš„ Agent é—®ç­”æµç¨‹**

```python
class DocumentQA:
    """æ–‡æ¡£é—®ç­” Agentï¼šæ”¯æŒå¤šè½®æ–‡ä»¶è¯»å–"""

    def __init__(self, agent_id: str):
        self.agent_id = agent_id
        self.file_tool = SandboxFileTool(agent_id)
        self.current_file = None

    async def answer_question(self, question: str, context: list = []) -> str:
        """å›ç­”ç”¨æˆ·é—®é¢˜ï¼ˆå¯èƒ½éœ€è¦å¤šæ¬¡è¯»å–æ–‡ä»¶ï¼‰"""

        # 1. æ£€æŸ¥é—®é¢˜æ˜¯å¦éœ€è¦è¯»å–æ–‡ä»¶
        if self._needs_file_read(question):
            # 2. ç¡®å®šè¯»å–ç­–ç•¥ï¼ˆåˆ†é¡µè¯»å–ï¼‰
            read_plan = self._plan_file_reads(question)

            # 3. æ‰§è¡Œå¤šæ¬¡è¯»å–ï¼ˆæ¯æ¬¡å¤ç”¨ä¼šè¯ï¼‰
            file_contents = []
            for start, end in read_plan:
                content = await self.file_tool.read_pdf_pages(
                    self.current_file,
                    start,
                    end
                )
                file_contents.append(content)

            # 4. ç»¼åˆæ–‡ä»¶å†…å®¹
            full_context = self._merge_contents(file_contents)
            context.extend(full_context)

        # 5. è°ƒç”¨ LLM ç”Ÿæˆç­”æ¡ˆ
        answer = await self._call_llm(question, context)

        return answer

    def _needs_file_read(self, question: str) -> bool:
        """åˆ¤æ–­æ˜¯å¦éœ€è¦è¯»å–æ–‡ä»¶"""
        keywords = ["æ–‡æ¡£", "æ–‡ä»¶", "PDF", "å†…å®¹", "æ€»ç»“", "æ¦‚è¿°"]
        return any(kw in question for kw in keywords)

    def _plan_file_reads(self, question: str) -> list[tuple]:
        """è§„åˆ’æ–‡ä»¶è¯»å–ç­–ç•¥ï¼ˆåˆ†é¡µï¼‰"""
        # ç®€åŒ–ç­–ç•¥ï¼šæ¯æ¬¡è¯»å– 10 é¡µ
        return [(1, 10), (11, 20), (21, 30)]
```

**Template å®šä¹‰ï¼ˆä¿æŒä¸å˜ï¼‰**

```python
# Template: file-parser
FILE_PARSER_TEMPLATE = {
    "id": "file-parser",
    "name": "Multi-format File Parser",
    "image": "sandbox-file-parser:v1.0",
    "base_image": "python:3.11-slim",
    "pre_installed_packages": [
        "PyPDF2>=3.0.0",      # PDF è§£æ
        "pdfplumber>=0.10.0",  # å¢å¼º PDF è§£æ
        "python-docx>=1.0.0",  # DOCX è§£æ
        "openpyxl>=3.1.0",     # Excel è§£æ
        "Pillow>=10.0.0",      # å›¾ç‰‡å¤„ç†
        "pytesseract>=0.3.10", # OCR
        "pandas>=2.0.0",       # CSV/Excel
    ],
    "default_resources": {
        "cpu": "1",
        "memory": "1Gi",
        "disk": "2Gi"
    },
    "timeout": 60  # æ–‡ä»¶è§£æé€šå¸¸ä¸è¶…è¿‡ 60 ç§’
}
```

**2. æ–‡ä»¶è§£æ Handler ä»£ç **

```python
# sandbox-executor æ‰§è¡Œçš„è§£æä»£ç 
PARSER_HANDLER_CODE = """
import os
import sys
import json
from pathlib import Path

def handler(event):
    '''æ–‡ä»¶è§£æå…¥å£'''
    file_path = event.get('file_path', '/tmp/input.pdf')
    file_type = event.get('file_type', 'auto')

    # è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹
    if file_type == 'auto':
        file_type = Path(file_path).suffix.lower()

    result = {
        'file_path': file_path,
        'file_type': file_type,
        'content': None,
        'metadata': {},
        'error': None
    }

    try:
        # PDF è§£æ
        if file_type in ['.pdf']:
            from pdfplumber import PDF
            with PDF(file_path) as pdf:
                pages = []
                for page in pdf.pages:
                    pages.append(page.extract_text())
                result['content'] = '\\n\\n'.join(pages)
                result['metadata'] = {
                    'total_pages': len(pdf.pages),
                    'format': 'PDF'
                }

        # DOCX è§£æ
        elif file_type in ['.docx']:
            from docx import Document
            doc = Document(file_path)
            paragraphs = [p.text for p in doc.paragraphs]
            result['content'] = '\\n\\n'.join(paragraphs)
            result['metadata'] = {
                'total_paragraphs': len(paragraphs),
                'format': 'DOCX'
            }

        # CSV/Excel è§£æ
        elif file_type in ['.csv', '.xlsx', '.xls']:
            import pandas as pd
            if file_type == '.csv':
                df = pd.read_csv(file_path)
            else:
                df = pd.read_excel(file_path)

            # è½¬æ¢ä¸ºæ–‡æœ¬è¡¨ç¤ºï¼ˆå‰ 100 è¡Œï¼‰
            result['content'] = df.head(100).to_string()
            result['metadata'] = {
                'rows': len(df),
                'columns': len(df.columns),
                'column_names': list(df.columns),
                'format': 'CSV/Excel'
            }

        # å›¾ç‰‡ OCR
        elif file_type in ['.png', '.jpg', '.jpeg', '.gif', '.bmp']:
            from PIL import Image
            import pytesseract

            image = Image.open(file_path)
            text = pytesseract.image_to_string(image)
            result['content'] = text
            result['metadata'] = {
                'format': 'Image',
                'mode': image.mode,
                'size': image.size
            }

        else:
            result['error'] = f'Unsupported file type: {file_type}'

    except Exception as e:
        result['error'] = str(e)
        import traceback
        result['traceback'] = traceback.format_exc()

    return result
"""
```

**3. Agent ä¾§è°ƒç”¨ä»£ç **

```python
class FileQAHandler:
    """æ–‡ä»¶é—®ç­”å¤„ç†å™¨ï¼ˆAgent ç»´æŠ¤ session_idï¼‰"""

    def __init__(self):
        self.session_id = None  # Agent ç»´æŠ¤çš„ session_id
        self.api_base = os.environ["SANDBOX_API"]

    async def handle_file_question(self, file_path: str, question: str):
        # 1. ç¡®ä¿ session å­˜åœ¨ï¼ˆå¤ç”¨æˆ–åˆ›å»ºï¼‰
        if not self.session_id:
            self.session_id = await self._create_session()

        # 2. ä¸Šä¼ æ–‡ä»¶åˆ° session workspace
        await self._upload_file_to_session(self.session_id, file_path)

        # 3. æ‰§è¡Œæ–‡ä»¶è§£æ
        parse_result = await self._execute_in_session(
            self.session_id,
            PARSER_HANDLER_CODE,
            event={
                "file_path": f"/workspace/{os.path.basename(file_path)}",
                "file_type": "auto"
            }
        )

        if parse_result["status"] != "success":
            return {"error": "Failed to parse file", "details": parse_result["stderr"]}

        # 4. åŸºäºè§£æå†…å®¹è°ƒç”¨ LLM
        extracted_text = parse_result["return_value"]["content"]
        answer = await self._call_llm(extracted_text, question)

        return {
            "answer": answer,
            "metadata": parse_result["return_value"]["metadata"]
        }

    async def _create_session(self) -> str:
        """åˆ›å»ºæ–° session"""
        response = await http_client.post(
            f"{self.api_base}/api/v1/sessions",
            json={
                "template_id": "file-parser",
                "timeout": 3600
            }
        )
        return response.json()["session_id"]

    async def _upload_file_to_session(self, session_id: str, file_path: str):
        """ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®š session çš„ workspace"""
        async with httpx.AsyncClient() as client:
            with open(file_path, "rb") as f:
                files = {"file": (os.path.basename(file_path), f)}
                await client.post(
                    f"{self.api_base}/api/v1/sessions/{session_id}/files/upload",
                    files=files
                )
```

#### 3.2.4 æ€§èƒ½æŒ‡æ ‡éªŒè¯

| æ–‡ä»¶ç±»å‹ | æ–‡ä»¶å¤§å° | é¢„æœŸè§£ææ—¶é—´ | éªŒè¯æ–¹æ³• |
|---------|---------|-------------|---------|
| PDFï¼ˆæ–‡æœ¬ï¼‰ | 5MB | < 3s | pdfplumber è§£ææ€§èƒ½ |
| PDFï¼ˆæ‰«æä»¶ï¼‰ | 5MB | < 10s | OCR å¤„ç†æ€§èƒ½ |
| DOCX | 1MB | < 2s | python-docx è§£æ |
| CSV | 10MB | < 3s | pandas è¯»å–æ€§èƒ½ |
| Excel | 5MB | < 3s | openpyxl è¯»å–æ€§èƒ½ |
| å›¾ç‰‡ OCR | 2MB | < 5s | pytesseract æ€§èƒ½ |

---

## 4. ç»Ÿä¸€ä¸´æ—¶åŒºèƒ½åŠ›éªŒè¯

### 4.1 èƒ½åŠ›çŸ©é˜µ

| èƒ½åŠ›éœ€æ±‚ | PTC æ•°æ®åˆ†æåœºæ™¯ | é PTC é—®ç­”åœºæ™¯ | v2.1 æ¶æ„æ”¯æŒ |
|---------|-----------------|----------------|--------------|
| **æ–‡ä»¶æŒä¹…åŒ–** | âœ… éœ€è¦ï¼ˆä¸­é—´ç»“æœï¼‰ | âœ… éœ€è¦ï¼ˆæ–‡ä»¶é‡å¤è¯»å–ï¼‰ | âœ… S3 workspace |
| **ä¼šè¯å¤ç”¨** | âœ… å¤šæ­¥éª¤æ‰§è¡Œ | âœ… å¤šè½®è¯»å– | âœ… Agent ç»´æŠ¤ session_id |
| **ä¾èµ–ç®¡ç†** | âœ… pandas/numpy/matplotlib | âœ… PDF/OCR è§£æåº“ | âœ… Template é¢„è£…ä¾èµ– |
| **æ–‡ä»¶ä¸Šä¼ ** | âœ… ç”¨æˆ·æ•°æ®æ–‡ä»¶ | âœ… å¾…è§£ææ–‡ä»¶ | âœ… æ–‡ä»¶ API |
| **ç»“æœä¸‹è½½** | âœ… ç”Ÿæˆçš„å›¾è¡¨/æ–‡ä»¶ | âœ… è§£æç»“æœ | âœ… é¢„ç­¾å URL |
| **æ‰§è¡Œè¶…æ—¶** | âœ… é•¿è¶…æ—¶ï¼ˆ300s+ï¼‰ | âœ… çŸ­è¶…æ—¶ï¼ˆ60sï¼‰ | âœ… å¯é…ç½® timeout |
| **èµ„æºéš”ç¦»** | âœ… é«˜èµ„æºéœ€æ±‚ | âœ… ä½èµ„æºéœ€æ±‚ | âœ… èµ„æºé…é¢ |
| **ç½‘ç»œéš”ç¦»** | âœ… é»˜è®¤æ— ç½‘ç»œ | âœ… é»˜è®¤æ— ç½‘ç»œ | âœ… NetworkMode=none |
| **å®‰å…¨éš”ç¦»** | âœ… å¼ºéš”ç¦»è¦æ±‚ | âœ… å¼ºéš”ç¦»è¦æ±‚ | âœ… å®¹å™¨ + Bubblewrap |

### 4.2 åŒä¸€å®¹å™¨å¤šåœºæ™¯éªŒè¯

**éªŒè¯ç›®æ ‡**ï¼šè¯æ˜åŒä¸€å®¹å™¨å®ä¾‹èƒ½å¤ŸåŒæ—¶æ”¯æŒ PTC å’Œé—®ç­”ä¸¤ç§åœºæ™¯ã€‚

```python
# éªŒè¯ç”¨ä¾‹ï¼šåœ¨åŒä¸€ä¸ª session ä¸­åŒæ—¶æ”¯æŒæ•°æ®åˆ†æå’Œæ–‡ä»¶è§£æ

async def test_unified_capability():
    """æµ‹è¯•ç»Ÿä¸€ä¸´æ—¶åŒºèƒ½åŠ›"""
    session_id = await create_session()

    # 1. PTC èƒ½åŠ›ï¼šæ•°æ®åˆ†æ
    analysis_code = """
import pandas as pd
import numpy as np

# åˆ›å»ºæµ‹è¯•æ•°æ®
data = {
    'A': np.random.randn(100),
    'B': np.random.randn(100)
}
df = pd.DataFrame(data)

# ä¿å­˜åˆ° workspace
df.to_csv('/workspace/test_data.csv', index=False)

return {
    'mean_A': float(df['A'].mean()),
    'mean_B': float(df['B'].mean())
}
"""
    result1 = await execute_in_session(session_id, analysis_code)
    assert result1["status"] == "success"
    assert "mean_A" in result1["return_value"]
    print("âœ… PTC capability verified")

    # 2. é—®ç­”èƒ½åŠ›ï¼šæ–‡ä»¶è§£æï¼ˆåœ¨åŒä¸€ä¼šè¯ä¸­ï¼‰
    parse_code = """
from pathlib import Path

# è¯»å–åˆšæ‰ç”Ÿæˆçš„ CSV æ–‡ä»¶
with open('/workspace/test_data.csv', 'r') as f:
    content = f.read()

return {
    'file_content': content[:500],  # å‰ 500 å­—ç¬¦
    'line_count': len(content.split('\\n'))
}
"""
    result2 = await execute_in_session(session_id, parse_code)
    assert result2["status"] == "success"
    assert "file_content" in result2["return_value"]
    print("âœ… File parsing capability verified")

    # 3. æ¸…ç†
    await terminate_session(session_id)
    print("âœ… Unified temporary area capability fully verified")
```

---

## 5. å®‰å…¨æ€§éªŒè¯

### 5.1 éš”ç¦»èƒ½åŠ›éªŒè¯çŸ©é˜µ

| éš”ç¦»å±‚é¢ | æŠ€æœ¯ | PTC åœºæ™¯éœ€æ±‚ | é—®ç­”åœºæ™¯éœ€æ±‚ | éªŒè¯æ–¹æ³• |
|---------|------|------------|------------|---------|
| **å®¹å™¨éš”ç¦»** | Docker/Pod | âœ… è¿›ç¨‹çº§éš”ç¦» | âœ… è¿›ç¨‹çº§éš”ç¦» | å®¹å™¨é€ƒé€¸æµ‹è¯• |
| **æ–‡ä»¶ç³»ç»Ÿ** | Union FS | âœ… ç‹¬ç«‹ rootfs | âœ… ç‹¬ç«‹ rootfs | æ–‡ä»¶ç³»ç»Ÿè®¿é—®æµ‹è¯• |
| **ç½‘ç»œéš”ç¦»** | NetworkMode=none | âœ… ç¦æ­¢å¤–ç½‘ | âœ… ç¦æ­¢å¤–ç½‘ | ç½‘ç»œè¿æ¥æµ‹è¯• |
| **è¿›ç¨‹éš”ç¦»** | Bubblewrap | âœ… äºŒå±‚éš”ç¦» | âœ… äºŒå±‚éš”ç¦» | bwrap é€ƒé€¸æµ‹è¯• |
| **èµ„æºé™åˆ¶** | cgroup | âœ… CPU/å†…å­˜é™åˆ¶ | âœ… CPU/å†…å­˜é™åˆ¶ | èµ„æºè€—å°½æµ‹è¯• |
| **æƒé™é™åˆ¶** | CAP_DROP=ALL | âœ… æœ€å°æƒé™ | âœ… æœ€å°æƒé™ | ç‰¹æƒæ“ä½œæµ‹è¯• |

### 5.2 å®‰å…¨æµ‹è¯•ç”¨ä¾‹

```python
class SecurityTests:
    """å®‰å…¨æ€§æµ‹è¯•å¥—ä»¶"""

    async def test_container_isolation(self):
        """æµ‹è¯•å®¹å™¨éš”ç¦»ï¼šç¡®ä¿æ— æ³•é€ƒé€¸"""
        malicious_code = """
import os
import subprocess

# å°è¯•è®¿é—®å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿ
try:
    # è¯»å–å®¿ä¸»æœº /etc/passwdï¼ˆåº”å¤±è´¥ï¼‰
    with open('/proc/1/root/etc/passwd', 'r') as f:
        return {'escape': True, 'content': f.read()}
except Exception as e:
    return {'escape': False, 'error': str(e)}
"""
        result = await execute_in_session(malicious_code)
        assert result["status"] == "success"
        assert result["return_value"]["escape"] == False

    async def test_network_isolation(self):
        """æµ‹è¯•ç½‘ç»œéš”ç¦»ï¼šç¡®ä¿æ— æ³•è®¿é—®å¤–ç½‘"""
        network_test_code = """
import urllib.request

try:
    # å°è¯•è®¿é—®ç™¾åº¦ï¼ˆåº”è¶…æ—¶ï¼‰
    response = urllib.request.urlopen('http://www.baidu.com', timeout=5)
    return {'network_access': True}
except Exception as e:
    return {'network_access': False, 'error': str(e)}
"""
        result = await execute_in_session(network_test_code)
        assert result["return_value"]["network_access"] == False

    async def test_resource_limits(self):
        """æµ‹è¯•èµ„æºé™åˆ¶ï¼šç¡®ä¿æ— æ³•è¶…é™"""
        memory_test_code = """
# å°è¯•åˆ†é…è¶…å¤§å†…å­˜ï¼ˆåº”è¢«é™åˆ¶ï¼‰
data = 'x' * (10 * 1024 * 1024 * 1024)  # 10GB
return {'success': True, 'allocated_gb': 10}
"""
        result = await execute_in_session(
            memory_test_code,
            resources={"memory": "512Mi"}  # é™åˆ¶ 512MB
        )
        assert result["status"] == "failed"  # åº”å› å†…å­˜ä¸è¶³å¤±è´¥
```

---

## 6. æ€§èƒ½åŸºå‡†æµ‹è¯•

### 6.1 æµ‹è¯•åœºæ™¯å®šä¹‰

| åœºæ™¯ç¼–å· | åœºæ™¯æè¿° | ä¼šè¯æ¨¡å¼ | æ–‡ä»¶å¤§å° | æ‰§è¡Œç±»å‹ |
|---------|---------|---------|---------|---------|
| PTC-01 | å°æ•°æ®é›†åˆ†æ | æŒä¹… | 10MB CSV | æ•°æ®æ¸…æ´— + ç»Ÿè®¡ |
| PTC-02 | ä¸­æ•°æ®é›†åˆ†æ | æŒä¹… | 100MB CSV | èšåˆ + å¯è§†åŒ– |
| PTC-03 | å¤šæ­¥éª¤åˆ†æ | æŒä¹… | 50MB | 3 æ­¥æ“ä½œé“¾ |
| QA-01 | PDF æ–‡æœ¬æå– | ä¸´æ—¶ | 5MB | å•æ¬¡è§£æ |
| QA-02 | å›¾ç‰‡ OCR | ä¸´æ—¶ | 2MB JPG | OCR æå– |
| QA-03 | Excel è§£æ | ä¸´æ—¶ | 10MB XLSX | å•æ¬¡è§£æ |

### 6.2 æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | PTC åœºæ™¯ç›®æ ‡ | QA åœºæ™¯ç›®æ ‡ | æ€»ä½“ç›®æ ‡ |
|------|------------|-----------|---------|
| **å†·å¯åŠ¨å»¶è¿Ÿ** | < 5s | < 3s | < 5s |
| **çƒ­å¯åŠ¨å»¶è¿Ÿ** | < 100ms | < 100ms | < 100ms |
| **æ‰§è¡Œå»¶è¿Ÿ** | < 5sï¼ˆ100MBï¼‰ | < 3sï¼ˆ5MB PDFï¼‰ | < 10s |
| **æ–‡ä»¶ä¸Šä¼ ** | < 2sï¼ˆ10MBï¼‰ | < 1sï¼ˆ5MBï¼‰ | < 5sï¼ˆ50MBï¼‰ |
| **ç»“æœä¸‹è½½** | < 1s | < 1s | < 3s |
| **å¹¶å‘èƒ½åŠ›** | Agent å¤ç”¨ä¼šè¯åœºæ™¯ | Agent å¤ç”¨ä¼šè¯åœºæ™¯ | 250 æ€»å¹¶å‘ |
| **å†…å­˜å ç”¨** | < 2Gi | < 1Gi | < 4Gi æ€»è®¡ |

### 6.3 æµ‹è¯•è„šæœ¬

```python
class PerformanceBenchmark:
    """æ€§èƒ½åŸºå‡†æµ‹è¯•"""

    async def benchmark_ptc_cold_start(self):
        """æµ‹è¯• PTC åœºæ™¯å†·å¯åŠ¨æ€§èƒ½"""
        start = time.perf_counter()

        session_id = await create_session()
        wait_time = time.perf_counter() - start

        assert wait_time < 5.0, f"Cold start too slow: {wait_time:.2f}s"
        print(f"âœ… PTC cold start: {wait_time:.2f}s")

        await terminate_session(session_id)

    async def benchmark_ptc_hot_start(self):
        """æµ‹è¯• PTC åœºæ™¯çƒ­å¯åŠ¨æ€§èƒ½"""
        session_id = await create_session()
        await asyncio.sleep(1)  # ç­‰å¾…å®¹å™¨å°±ç»ª

        # æµ‹è¯•è¿ç»­æ‰§è¡Œå»¶è¿Ÿ
        latencies = []
        for i in range(10):
            start = time.perf_counter()

            await execute_in_session(session_id, "return {'test': 1}")

            latency = (time.perf_counter() - start) * 1000  # ms
            latencies.append(latency)

        avg_latency = sum(latencies) / len(latencies)
        max_latency = max(latencies)

        assert avg_latency < 100, f"Hot start too slow: {avg_latency:.2f}ms"
        print(f"âœ… PTC hot start: avg={avg_latency:.2f}ms, max={max_latency:.2f}ms")

        await terminate_session(session_id)

    async def benchmark_qa_throughput(self):
        """æµ‹è¯•é—®ç­”åœºæ™¯ååé‡"""
        concurrent_requests = 50
        file_size = "5MB"

        async def single_request():
            result = await handle_file_question(
                file_path=f"test_{file_size}.pdf",
                question="æ€»ç»“æ–‡æ¡£å†…å®¹"
            )
            return result

        start = time.perf_counter()

        # å¹¶å‘æ‰§è¡Œ
        tasks = [single_request() for _ in range(concurrent_requests)]
        results = await asyncio.gather(*tasks)

        total_time = time.perf_counter() - start
        throughput = concurrent_requests / total_time

        assert throughput > 10, f"Throughput too low: {throughput:.2f} req/s"
        print(f"âœ… QA throughput: {throughput:.2f} req/s")
```

---

## 7. é›†æˆæ£€æŸ¥æ¸…å•

### 7.1 åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥

- [ ] **ä¼šè¯ç®¡ç†**
  - [ ] ä¼šè¯åˆ›å»º
  - [ ] ä¼šè¯è‡ªåŠ¨è¶…æ—¶å›æ”¶
  - [ ] ä¼šè¯æ‰‹åŠ¨ç»ˆæ­¢
  - [ ] ä¼šè¯çŠ¶æ€æŸ¥è¯¢
  - [ ] Agent ä¾§ session_id ç»´æŠ¤

- [ ] **æ–‡ä»¶æ“ä½œ**
  - [ ] æ–‡ä»¶ä¸Šä¼ åˆ° workspace
  - [ ] æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢
  - [ ] æ–‡ä»¶ä¸‹è½½ï¼ˆé¢„ç­¾å URLï¼‰
  - [ ] æ–‡ä»¶åˆ é™¤
  - [ ] ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†

- [ ] **æ‰§è¡Œç®¡ç†**
  - [ ] ä»£ç æ‰§è¡Œï¼ˆPythonï¼‰
  - [ ] æ‰§è¡ŒçŠ¶æ€æŸ¥è¯¢
  - [ ] æ‰§è¡Œç»“æœè·å–
  - [ ] æ‰§è¡Œå†å²æŸ¥è¯¢
  - [ ] æ‰§è¡Œè¶…æ—¶æ§åˆ¶

- [ ] **æ¨¡æ¿ç®¡ç†**
  - [ ] é¢„å®šä¹‰æ¨¡æ¿ï¼ˆpython-datascience, file-parserï¼‰
  - [ ] è‡ªå®šä¹‰æ¨¡æ¿åˆ›å»º
  - [ ] æ¨¡æ¿ä¾èµ–ç®¡ç†
  - [ ] æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶

- [ ] **å®‰å…¨éš”ç¦»**
  - [ ] å®¹å™¨éš”ç¦»
  - [ ] Bubblewrap è¿›ç¨‹éš”ç¦»
  - [ ] ç½‘ç»œéš”ç¦»
  - [ ] èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜/ç£ç›˜ï¼‰
  - [ ] æƒé™é™åˆ¶ï¼ˆCAP_DROPï¼‰

### 7.2 æ€§èƒ½æ£€æŸ¥

- [ ] **å»¶è¿ŸæŒ‡æ ‡**
  - [ ] å†·å¯åŠ¨ < 5s
  - [ ] çƒ­å¯åŠ¨ < 100ms
  - [ ] æ‰§è¡Œå“åº” < 500msï¼ˆç®€å•ä»£ç ï¼‰
  - [ ] æ–‡ä»¶ä¸Šä¼  < 5sï¼ˆ50MBï¼‰

- [ ] **ååé‡æŒ‡æ ‡**
  - [ ] æ€»å¹¶å‘ >= 250
  - [ ] Agent å¤ç”¨ä¼šè¯åœºæ™¯ >= 50
  - [ ] æ–°ä¼šè¯åœºæ™¯ >= 200

- [ ] **èµ„æºæŒ‡æ ‡**
  - [ ] å•å®¹å™¨å†…å­˜ < 2Gi
  - [ ] å•å®¹å™¨ CPU < 2 cores
  - [ ] é›†ç¾¤æ€»å†…å­˜å¯æ‰©å±•

### 7.3 å®‰å…¨æ£€æŸ¥

- [ ] **éš”ç¦»éªŒè¯**
  - [ ] å®¹å™¨é€ƒé€¸æµ‹è¯•é€šè¿‡
  - [ ] Bubblewrap é€ƒé€¸æµ‹è¯•é€šè¿‡
  - [ ] ç½‘ç»œéš”ç¦»æµ‹è¯•é€šè¿‡
  - [ ] æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æµ‹è¯•é€šè¿‡

- [ ] **æƒé™éªŒè¯**
  - [ ] éç‰¹æƒç”¨æˆ·è¿è¡Œ
  - [ ] CAP_DROP=ALL ç”Ÿæ•ˆ
  - [ ] seccomp è¿‡æ»¤ç”Ÿæ•ˆ

---

## 8. éƒ¨ç½²æ¶æ„

### 8.1 æ¨èéƒ¨ç½²æ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Kubernetes é›†ç¾¤                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     Namespace: sandbox-system (ç®¡ç†ä¸­å¿ƒ)                  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Deployment: control-plane (3 å‰¯æœ¬)                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - API Gateway                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Scheduler                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Session Manager                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Template Manager                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Health Probe                                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  HPA: Min=3, Max=10, CPU Target=70%               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Namespace: sandbox-runtime (è¿è¡Œæ—¶)                      â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Warm Pool: é¢„çƒ­å®ä¾‹æ±                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - python-datascience: 10 pods                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - file-parser: 20 pods                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Total: 30 pods (Ready)                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Active: æ‰§è¡Œä¸­å®¹å™¨                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Agent å¤ç”¨ä¼šè¯: 0-50 pods                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æ–°ä¼šè¯: 0-200 pods                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  NetworkPolicy: ç¦æ­¢ Pod é—´é€šä¿¡                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ResourceQuota: æ€» CPU 100 cores, å†…å­˜ 200Gi        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Namespace: data (æ•°æ®å±‚)                                 â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  StatefulSet: MariaDB (1 Primary + 2 Replicas)     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Storage: 50Gi PVC                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  StatefulSet: Etcd (3 nodes)                       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Deployment: Redis (Optional, ç”¨äºç¼“å­˜)             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  External Services (å¤–éƒ¨æœåŠ¡)                             â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  S3 / MinIO: å¯¹è±¡å­˜å‚¨                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - workspace å·æŒ‚è½½                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ä¸´æ—¶æ–‡ä»¶å­˜å‚¨                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - é¢„ç­¾å URL ç”Ÿæˆ                                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Container Registry: é•œåƒä»“åº“                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - sandbox-control-plane:v1.0                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - sandbox-python-datascience:v1.0                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - sandbox-file-parser:v1.0                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 èµ„æºè§„åˆ’

| ç»„ä»¶ | å‰¯æœ¬æ•° | CPU (æ¯å‰¯æœ¬) | å†…å­˜ (æ¯å‰¯æœ¬) | å­˜å‚¨ | æ€»èµ„æº |
|------|-------|-------------|-------------|------|--------|
| Control Plane | 3-10 | 500m-2 | 512Mi-2Gi | - | 2-20 CPU, 1.5-20Gi |
| MariaDB | 3 | 500m-2 | 1Gi-4Gi | 50Gi | 1.5-6 CPU, 3-12Gi |
| Etcd | 3 | 100m-500m | 256Mi-1Gi | 10Gi | 300m-1.5 CPU, 768Mi-3Gi |
| Warm Pool (datascience) | 10 | 500m-2 | 1Gi-2Gi | - | 5-20 CPU, 10-20Gi |
| Warm Pool (parser) | 20 | 200m-500m | 512Mi-1Gi | - | 4-10 CPU, 10-20Gi |
| Active Sessions | 0-250 | 100m-2 | 256Mi-2Gi | - | 0-500 CPU, 0-500Gi |
| **æ€»è®¡** | - | - | - | **110Gi** | **15-560 CPU, 35-575Gi** |

---

## 9. å®æ–½è·¯çº¿å›¾

### 9.1 é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µ 1ï¼šæ ¸å¿ƒèƒ½åŠ›å®ç°ï¼ˆ4-6 å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®ç°åŸºç¡€çš„æ²™ç®±æ‰§è¡Œèƒ½åŠ›

- [ ] **Week 1-2: Control Plane åŸºç¡€**
  - [ ] API Gateway æ­å»º
  - [ ] Session Manager å®ç°
  - [ ] MariaDB æ•°æ®åº“æ¨¡å‹
  - [ ] Template Manager åŸºç¡€åŠŸèƒ½

- [ ] **Week 3-4: Runtime åŸºç¡€**
  - [ ] Docker Runtime å®ç°
  - [ ] sandbox-executor å¼€å‘
  - [ ] Bubblewrap éš”ç¦»é…ç½®
  - [ ] S3 workspace æŒ‚è½½

- [ ] **Week 5-6: é›†æˆæµ‹è¯•**
  - [ ] ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
  - [ ] å®‰å…¨éš”ç¦»æµ‹è¯•
  - [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

#### é˜¶æ®µ 2ï¼šå¹³å°åŒ–èƒ½åŠ›ï¼ˆ4-6 å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®ç°è°ƒåº¦ã€é¢„çƒ­æ± ã€ä¼šè¯ç®¡ç†

- [ ] **Week 7-8: è°ƒåº¦å™¨**
  - [ ] æ™ºèƒ½è°ƒåº¦ç®—æ³•
  - [ ] Warm Pool ç®¡ç†
  - [ ] Health Probe å®ç°

- [ ] **Week 9-10: ä¼šè¯ç®¡ç†**
  - [ ] ä¼šè¯åˆ›å»ºä¸é”€æ¯
  - [ ] ä¼šè¯çŠ¶æ€ç®¡ç†
  - [ ] ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - [ ] Agent ä¾§ session_id ç®¡ç†ç¤ºä¾‹

- [ ] **Week 11-12: é«˜çº§ç‰¹æ€§**
  - [ ] æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½
  - [ ] æ‰§è¡Œå†å²æŸ¥è¯¢
  - [ ] æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶

#### é˜¶æ®µ 3ï¼šç”Ÿäº§å°±ç»ªï¼ˆ4-6 å‘¨ï¼‰

**ç›®æ ‡**ï¼šç›‘æ§ã€ä¼˜åŒ–ã€Kubernetes éƒ¨ç½²

- [ ] **Week 13-14: Kubernetes Runtime**
  - [ ] K8s Runtime å®ç°
  - [ ] Pod ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - [ ] RBAC é…ç½®

- [ ] **Week 15-16: å¯è§‚æµ‹æ€§**
  - [ ] Prometheus æŒ‡æ ‡
  - [ ] ç»“æ„åŒ–æ—¥å¿—
  - [ ] åˆ†å¸ƒå¼è¿½è¸ª

- [ ] **Week 17-18: æ€§èƒ½ä¼˜åŒ–**
  - [ ] é¢„çƒ­æ± ä¼˜åŒ–
  - [ ] è¿æ¥æ± ä¼˜åŒ–
  - [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### 9.2 é‡Œç¨‹ç¢‘å®šä¹‰

| é‡Œç¨‹ç¢‘ | äº¤ä»˜ç‰© | éªŒæ”¶æ ‡å‡† |
|-------|-------|---------|
| **M1: æ ¸å¿ƒèƒ½åŠ›** | åŸºç¡€æ²™ç®±æ‰§è¡Œ | èƒ½æ‰§è¡Œ Python ä»£ç ï¼ŒåŒå±‚éš”ç¦»ç”Ÿæ•ˆ |
| **M2: å¹³å°åŒ–** | å®Œæ•´ç®¡ç†å¹³å° | æ”¯æŒ Agent äº²å’Œæ€§è°ƒåº¦ï¼Œè°ƒåº¦å™¨å·¥ä½œ |
| **M3: ç”Ÿäº§å°±ç»ª** | K8s éƒ¨ç½²æ–¹æ¡ˆ | æ”¯æŒ 250 å¹¶å‘ï¼Œé€šè¿‡å®‰å…¨æµ‹è¯• |
| **M4: ç«¯åˆ°ç«¯éªŒè¯** | PTC + QA åœºæ™¯éªŒè¯ | é€šè¿‡æ‰€æœ‰é›†æˆæµ‹è¯•ç”¨ä¾‹ |

---

## 10. é£é™©ä¸ç¼“è§£

### 10.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| Bubblewrap å…¼å®¹æ€§ | é«˜ | ä¸­ | æå‰éªŒè¯ macOS/Linux å…¼å®¹æ€§ï¼Œå‡†å¤‡å®¹å™¨çº§éš”ç¦»é™çº§æ–¹æ¡ˆ |
| S3 æŒ‚è½½æ€§èƒ½ | ä¸­ | é«˜ | å¯¹æ¯” s3fs/geesefs/goofysï¼Œé€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆï¼Œè€ƒè™‘æœ¬åœ°ç¼“å­˜ |
| Agent ä¼šè¯ç®¡ç†å¤æ‚åº¦ | ä¸­ | ä¸­ | ç®€åŒ–è°ƒåº¦ç­–ç•¥ï¼Œæä¾›æ¸…æ™°çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† API |
| å®¹å™¨é€ƒé€¸ | é«˜ | ä½ | å¤šå±‚é˜²å¾¡ï¼Œå®šæœŸå®‰å…¨å®¡è®¡ï¼ŒåŠæ—¶æ›´æ–°é•œåƒ |

### 10.2 å®æ–½é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| è¿›åº¦å»¶æœŸ | é«˜ | ä¸­ | åˆ†é˜¶æ®µäº¤ä»˜ï¼Œä¼˜å…ˆæ ¸å¿ƒåŠŸèƒ½ï¼ŒMVP ä¼˜å…ˆ |
| æ€§èƒ½ä¸è¾¾æ ‡ | é«˜ | ä½ | æ—©æœŸæ€§èƒ½æµ‹è¯•ï¼Œé¢„ç•™ä¼˜åŒ–æ—¶é—´ |
| é›†æˆå¤æ‚åº¦ | ä¸­ | ä¸­ | åè®®é©±åŠ¨è®¾è®¡ï¼ŒMock æµ‹è¯•å…ˆè¡Œ |
| å¼‚æ­¥ API å¯¹ Agent ä¸å‹å¥½ | ä¸­ | ä¸­ | å·¥å…·å±‚æä¾›åŒæ­¥å°è£…ï¼Œé™ä½ä½¿ç”¨é—¨æ§› |

---

## 11. é™„å½•

### 11.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| **PTC** | Programmatic Tool Callï¼ˆç¨‹åºåŒ–å·¥å…·è°ƒç”¨ï¼‰ï¼šAgent è‡ªä¸»ç”Ÿæˆä»£ç å¹¶é€šè¿‡å·¥å…·è°ƒç”¨æ‰§è¡Œ |
| **Agent ä¾§ä¼šè¯ç®¡ç†** | Agent ç»´æŠ¤ session_idï¼Œæ²™ç®±å¹³å°æä¾›ç»Ÿä¸€æ‰§è¡Œ API |
| **ç»Ÿä¸€ä¼šè¯æ¨¡å‹** | å•ä¸€ä¼šè¯ç±»å‹ï¼Œç”± Agent å†³å®šä½•æ—¶å¤ç”¨ã€é”€æ¯ |
| **é¢„çƒ­æ± ** | é¢„å…ˆå¯åŠ¨å¹¶ä¿æŒå°±ç»ªçŠ¶æ€çš„å®¹å™¨å®ä¾‹æ±  |
| **Workspace** | é€šè¿‡ S3 æŒ‚è½½çš„æŒä¹…åŒ–å·¥ä½œç›®å½• |
| **åŒå±‚éš”ç¦»** | å®¹å™¨çº§éš”ç¦» + Bubblewrap è¿›ç¨‹çº§éš”ç¦» |
| **åŒæ­¥å°è£…** | å·¥å…·å±‚å¯¹å¼‚æ­¥ API çš„å°è£…ï¼Œæä¾›é˜»å¡ç­‰å¾…çš„åŒæ­¥æ¥å£ |

### 11.2 å‚è€ƒæ–‡æ¡£

- `sandbox-design-v1.md` - åŸå§‹è®¾è®¡æ–‡æ¡£ï¼Œç¬¬ 1.4 èŠ‚å®šä¹‰ä¸šåŠ¡åœºæ™¯
- `sandbox-design-v2.1.md` - å®Œæ•´æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£ï¼ˆå·²ç§»é™¤æŒä¹…/ä¸´æ—¶ä¼šè¯æ¦‚å¿µï¼‰
- `sandbox-cli-design.md` - CLI å·¥å…·è§„èŒƒ
- `sandbox-runtime-v1.md` - Lambda å…¼å®¹è¿è¡Œæ—¶è§„èŒƒ

### 11.3 API å‚è€ƒå¿«é€Ÿç´¢å¼•

| API | ç”¨é€” |
|-----|------|
| `POST /api/v1/agents/{agent_id}/execute` | Agent æ‰§è¡Œä»£ç ï¼ˆè‡ªåŠ¨ä¼šè¯å¤ç”¨ï¼‰ |
| `POST /api/v1/agents/{agent_id}/files/upload` | ä¸Šä¼ æ–‡ä»¶åˆ° Agent workspace |
| `GET /api/v1/agents/{agent_id}/files/{name}` | ä¸‹è½½æ–‡ä»¶ |
| `GET /api/v1/executions/{eid}/result` | è·å–æ‰§è¡Œç»“æœ |
| `POST /api/v1/sessions` | æ‰‹åŠ¨åˆ›å»ºä¼šè¯ï¼ˆé«˜çº§ç”¨æ³•ï¼‰ |
| `GET /api/v1/sessions/{id}` | æŸ¥è¯¢ä¼šè¯çŠ¶æ€ |
| `DELETE /api/v1/sessions/{id}` | ç»ˆæ­¢ä¼šè¯ |

---

## 12. ç»“è®º

æœ¬æ–‡æ¡£é€šè¿‡è¯¦ç»†çš„ç«¯åˆ°ç«¯åœºæ™¯éªŒè¯ï¼Œè¯æ˜äº† **v2.1 æŠ€æœ¯æ¶æ„å®Œå…¨æ»¡è¶³ v1.4 å®šä¹‰çš„ç»Ÿä¸€æ²™ç®±ä¸´æ—¶åŒºä¸šåŠ¡éœ€æ±‚**ï¼š

### æ ¸å¿ƒéªŒè¯ç»“è®º

1. âœ… **ç»Ÿä¸€èƒ½åŠ›éªŒè¯**ï¼šåŒä¸€æ²™ç®±å®ä¾‹æ—¢èƒ½æ‰§è¡Œ PTC æ•°æ®åˆ†æï¼Œåˆèƒ½è§£æå„ç±»æ–‡ä»¶æ ¼å¼
2. âœ… **ç»Ÿä¸€ä¼šè¯æ¨¡å‹**ï¼šåŸºäº Agent ID çš„ä¼šè¯å¤ç”¨ï¼Œæ”¯æŒ PTC å’Œé—®ç­”åœºæ™¯
3. âœ… **æ–‡ä»¶å¤„ç†æµç¨‹**ï¼šS3 workspace æä¾›å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ ã€æŒä¹…åŒ–ã€ä¸‹è½½é“¾è·¯
4. âœ… **Agent å‹å¥½ API**ï¼šå·¥å…·å±‚æä¾›åŒæ­¥å°è£…ï¼Œç®€åŒ– Agent é›†æˆ
5. âœ… **å®‰å…¨éš”ç¦»ä¿è¯**ï¼šå®¹å™¨ + Bubblewrap åŒå±‚éš”ç¦»æ»¡è¶³é«˜å®‰å…¨è¦æ±‚
6. âœ… **æ€§èƒ½ç›®æ ‡è¾¾æˆ**ï¼šå†·å¯åŠ¨ < 5sï¼ŒAgent äº²å’Œæ€§çƒ­å¯åŠ¨ < 50msï¼Œæ»¡è¶³å®æ—¶äº¤äº’éœ€æ±‚

### å…³é”®æŠ€æœ¯å†³ç­–

1. **æ— çŠ¶æ€æ¶æ„**ï¼šå®¹å™¨æ— çŠ¶æ€ï¼Œæ•°æ®åœ¨ S3ï¼Œæ”¯æŒå¼¹æ€§æ‰©å±•å’Œæ•…éšœè¿ç§»
2. **Agent ä¾§ä¼šè¯ç®¡ç†**ï¼šAgent ç»´æŠ¤ session_idï¼Œå®ç° 10-50ms çƒ­å¯åŠ¨å¤ç”¨
3. **æ¶æ„è§£è€¦**ï¼šæ²™ç®±å¹³å°æ— éœ€çŸ¥é“ Agent æ¦‚å¿µï¼Œä¸“æ³¨æä¾›æ‰§è¡Œèƒ½åŠ›
4. **é¢„çƒ­æ± ä¼˜åŒ–**ï¼šé«˜é¢‘æ¨¡æ¿é¢„å…ˆå¯åŠ¨ï¼Œå¤§å¹…é™ä½å†·å¯åŠ¨å»¶è¿Ÿ
5. **åè®®é©±åŠ¨**ï¼šRESTful API + HTTP å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ç°æ§åˆ¶å¹³é¢ä¸è¿è¡Œæ—¶è§£è€¦
6. **å·¥å…·å±‚å°è£…**ï¼šåŒæ­¥æ¥å£ç®€åŒ– Agent é›†æˆï¼Œå¼‚æ­¥æ¥å£æ”¯æŒé«˜çº§åœºæ™¯

### åœºæ™¯æœ¬è´¨æ€»ç»“

**PTC æ•°æ®åˆ†æåœºæ™¯**ï¼š
- Agent ç”Ÿæˆä»£ç  â†’ æ²™ç®±æ‰§è¡Œ â†’ ç»“æœè¿”å› Agent â†’ ç»§ç»­æ¨ç†
- å½¢æˆé—­ç¯ï¼šç”Ÿæˆ â†’ æ‰§è¡Œ â†’ åˆ†æ â†’ å†ç”Ÿæˆ
- ä¼šè¯è‡ªåŠ¨å¤ç”¨ï¼Œæ”¯æŒå¤šè½®è¿­ä»£

**é PTC é—®ç­”åœºæ™¯**ï¼š
- Agent ä¸Šä¼ æ–‡ä»¶ â†’ æ–‡ä»¶å­˜å‚¨åˆ° workspace
- Agent å¤šæ¬¡è°ƒç”¨ä»£ç è¯»å–æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†
- æ¯æ¬¡è¯»å–ç»“æœè¿”å›ç»™ Agent è¿›è¡Œæ¨ç†
- ä¼šè¯ä¿æŒæ´»è·ƒï¼Œæ”¯æŒå¤šè½®å¯¹è¯

**ç»Ÿä¸€ä¸´æ—¶åŒºèƒ½åŠ›**ï¼š
- æ–‡ä»¶æŒä¹…åŒ–ï¼ˆS3 workspaceï¼‰
- å¤æ‚ä¾èµ–å…¼å®¹ï¼ˆTemplate é¢„è£…ï¼‰
- åŒå±‚å®‰å…¨éš”ç¦»ï¼ˆå®¹å™¨ + Bubblewrapï¼‰

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¯åŠ¨**ï¼šåŸºäºé˜¶æ®µ 1 è®¡åˆ’å¼€å§‹æ ¸å¿ƒèƒ½åŠ›å¼€å‘
2. **å¹¶è¡ŒéªŒè¯**ï¼šæ­å»ºæµ‹è¯•ç¯å¢ƒï¼ŒæŒç»­éªŒè¯ç«¯åˆ°ç«¯åœºæ™¯
3. **è¿­ä»£ä¼˜åŒ–**ï¼šæ ¹æ®æµ‹è¯•ç»“æœä¼˜åŒ–è°ƒåº¦ç®—æ³•å’Œèµ„æºé…é¢
4. **ç”Ÿäº§å‡†å¤‡**ï¼šå®Œæˆé˜¶æ®µ 3 åï¼Œè¿›è¡Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

**æ–‡æ¡£çŠ¶æ€**: âœ… è®¾è®¡éªŒè¯å®Œæˆï¼Œå¯è¿›å…¥å®æ–½é˜¶æ®µ
