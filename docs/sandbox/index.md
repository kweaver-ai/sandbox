# æ²™ç®±å¹³å°æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡ - V2.1

> **Sandbox Platform Technical Design Document V2.1**

æœ¬æ–‡æ¡£æ˜¯ Sandbox Platform æ²™ç®±å¹³å°çš„å®Œæ•´æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆï¼Œæè¿°äº†ç³»ç»Ÿæ¶æ„ã€å…³é”®ç»„ä»¶ã€æ•°æ®æ¨¡å‹ã€å®‰å…¨è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œéƒ¨ç½²æ–¹æ¡ˆç­‰å†…å®¹ã€‚

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### [1. æ¶æ„è®¾è®¡](01-architecture.md)
- **1.1 æ•´ä½“æ¶æ„** - ç³»ç»Ÿè®¾è®¡åŸåˆ™å’Œæ ¸å¿ƒæ¦‚å¿µ
- **1.2 C4 æ¶æ„æ¨¡å‹** - ç³»ç»Ÿä¸Šä¸‹æ–‡å’Œå®¹å™¨è§†å›¾
- **1.3 éƒ¨ç½²æ¶æ„** - Kubernetes é›†ç¾¤éƒ¨ç½²æ¶æ„å›¾

### [2. å…³é”®ç»„ä»¶è®¾è®¡](#2-å…³é”®ç»„ä»¶è®¾è®¡)

#### [2.1 ç®¡ç†ä¸­å¿ƒ (Control Plane)](02-control-plane.md)
- **2.1.1 API Gateway** - RESTful API æ¥å£è®¾è®¡
- **2.1.2 è°ƒåº¦å™¨ (Scheduler)** - æ™ºèƒ½ä»»åŠ¡åˆ†å‘å’Œèµ„æºè°ƒåº¦
- **2.1.3 ä¼šè¯ç®¡ç†å™¨ (Session Manager)** - ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **2.1.4 ç›‘æ§æ¢é’ˆ (Health Probe)** - èŠ‚ç‚¹å¥åº·æ£€æµ‹æœºåˆ¶
- **2.1.5 çŠ¶æ€åŒæ­¥æœåŠ¡ (State Sync)** - å¯åŠ¨çŠ¶æ€åŒæ­¥å’Œæ•…éšœæ¢å¤

#### [2.2 Container Scheduler æ¨¡å—](03-container-scheduler.md)
- **2.2.1 Docker è¿è¡Œæ—¶** - Docker å®¹å™¨é…ç½®å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **2.2.2 Kubernetes è¿è¡Œæ—¶** - K8s Scheduler å®ç°å’Œ JuiceFS CSI Driver

#### [2.3 æ‰§è¡Œå™¨ (Executor)](04-executor.md)
- **2.3.1 æ‰§è¡Œå™¨æ¶æ„** - AWS Lambda-style Handler è®¾è®¡
- **2.3.2 æ‰§è¡Œç»“æœæ ¼å¼** - è¿”å›å€¼å’Œæ€§èƒ½æŒ‡æ ‡
- **2.3.3 Bubblewrap å®‰å…¨é…ç½®** - ç¬¬äºŒå±‚è¿›ç¨‹éš”ç¦»è¯¦è§£

### [3. å…³é”®æµç¨‹è®¾è®¡](05-processes-and-data-models.md#3-å…³é”®æµç¨‹è®¾è®¡)
- **3.1 ä¼šè¯åˆ›å»ºæµç¨‹** - å®Œæ•´çš„ä¼šè¯åˆ›å»ºæ—¶åºå›¾
- **3.2 ä»£ç æ‰§è¡Œæµç¨‹** - ä»è¯·æ±‚åˆ°ç»“æœçš„å®Œæ•´æµç¨‹
- **3.3 å¥åº·æ£€æŸ¥ä¸æ•…éšœæ¢å¤** - å®¹å™¨å¥åº·ç›‘æ§å’Œè‡ªåŠ¨æ¢å¤

### [4. æ•°æ®æ¨¡å‹è®¾è®¡](05-processes-and-data-models.md#4-æ•°æ®æ¨¡å‹è®¾è®¡)
- **4.1 æ ¸å¿ƒå®ä½“æ¨¡å‹** - Pydantic æ•°æ®æ¨¡å‹å®šä¹‰
- **4.2 åè®®å®šä¹‰** - å¤–éƒ¨ API å’Œå†…éƒ¨å›è°ƒ API
- **4.3 æ‰§è¡Œè¯­ä¹‰ä¸å¹‚ç­‰æ€§æ¨¡å‹** - execution_id ç”Ÿå‘½å‘¨æœŸå’Œé‡è¯•æœºåˆ¶
- **4.4 S3 Workspace æŒ‚è½½æ¶æ„** - Kubernetes + JuiceFS hostPath

### [5. Python ä¾èµ–ç®¡ç†](06-python-dependencies.md)
- **5.1 æ ¸å¿ƒä¾èµ–** - Web æ¡†æ¶ã€æ•°æ®åº“ã€å®¹å™¨è¿è¡Œæ—¶
- **5.2 å¼€å‘ä¾èµ–** - æµ‹è¯•ã€ä»£ç è´¨é‡ã€ç±»å‹æ£€æŸ¥
- **5.3 æ•°æ®åº“è¿ç§» (Alembic)** - SQLAlchemy Alembic é…ç½®
- **5.4 æ•°æ®åº“é…ç½®** - å¼‚æ­¥å¼•æ“å’Œè¿æ¥æ± 

### [6. å®‰å…¨è®¾è®¡](07-security-and-performance.md#6-å®‰å…¨è®¾è®¡)
- **6.1 å¤šå±‚éš”ç¦»ç­–ç•¥** - å®¹å™¨å±‚ + Bubblewrap å±‚
- **6.2 å®‰å…¨é…ç½®ç¤ºä¾‹** - Docker å’Œ Bubblewrap é…ç½®

### [7. æ€§èƒ½ä¼˜åŒ–](07-security-and-performance.md#7-æ€§èƒ½ä¼˜åŒ–)
- **7.1 å¯åŠ¨ä¼˜åŒ–** - åˆ†å±‚é•œåƒå’Œé¢„çƒ­æ± 
- **7.2 å¹¶å‘ä¼˜åŒ–** - å¼‚æ­¥å¤„ç†å’Œè¿æ¥æ± 

### [8. ç›‘æ§ä¸å¯è§‚æµ‹æ€§](08-monitoring-and-deployment.md#8-ç›‘æ§ä¸å¯è§‚æµ‹æ€§)
- **8.1 æŒ‡æ ‡å®šä¹‰** - ç³»ç»ŸæŒ‡æ ‡å’Œä¸šåŠ¡æŒ‡æ ‡
- **8.2 ç›‘æ§é›†æˆ** - Prometheus å’Œ Grafana

### [9. JuiceFS å­˜å‚¨æ¶æ„](09-juicefs-storage.md)
- **9.1 æ¦‚è¿°** - å…ƒæ•°æ®ä¸æ•°æ®åˆ†ç¦»æ¶æ„
- **9.2 è®¿é—®æ–¹å¼å¯¹æ¯”** - SDKã€FUSEã€S3 API
- **9.3 SDK æ¨¡å¼** - æ¨èçš„ CSI æ¨¡å¼å®ç°
- **9.4 FUSE æŒ‚è½½æ¨¡å¼** - hostPath DaemonSet å®ç°
- **9.5 CSI Driver é›†æˆ** - PV/PVC è‡ªåŠ¨æŒ‚è½½
- **9.6 æ•…éšœæ’æŸ¥** - å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### [10. MinIO-Only æ¶æ„æ–¹æ¡ˆ](10-minio-only-architecture.md) ğŸ’¡
- **10.1 é—®é¢˜åˆ†æ** - JuiceFS æ¶æ„ç—›ç‚¹
- **10.2 æ–¹æ¡ˆè®¾è®¡** - s3fs-fuse æŒ‚è½½æ–¹æ¡ˆ
- **10.3 å®ç°æ–¹æ¡ˆ** - ä»£ç å’Œé…ç½®ä¿®æ”¹
- **10.4 è¿ç§»æ­¥éª¤** - ä» JuiceFS è¿ç§»åˆ° MinIO
- **10.5 é£é™©è¯„ä¼°** - é£é™©å’Œç¼“è§£æªæ–½

### [11. éƒ¨ç½²æ–¹æ¡ˆ](08-monitoring-and-deployment.md#9-éƒ¨ç½²æ–¹æ¡ˆ)
- **9.1 Docker Compose éƒ¨ç½²** - å¼€å‘/å°è§„æ¨¡éƒ¨ç½²
- **9.2 Kubernetes éƒ¨ç½²** - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

ç³»ç»Ÿé‡‡ç”¨**ç®¡ç†ä¸­å¿ƒï¼ˆControl Planeï¼‰ä¸å®¹å™¨è°ƒåº¦å™¨ï¼ˆContainer Schedulerï¼‰åˆ†ç¦»**çš„äº‘åŸç”Ÿæ¶æ„ï¼Œæ”¯æŒ Docker å’Œ Kubernetes ä¸¤ç§éƒ¨ç½²æ¨¡å¼ã€‚

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **æ§åˆ¶å¹³é¢æ— çŠ¶æ€**ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
2. **å®¹å™¨è°ƒåº¦å™¨æ± åŒ–ç®¡ç†**ï¼ŒåŠ¨æ€ä¼¸ç¼©
3. **åè®®é©±åŠ¨çš„è§£è€¦è®¾è®¡**
4. **å¤šå±‚å®‰å…¨éš”ç¦»**ï¼ˆå®¹å™¨ + Bubblewrapï¼‰
5. **å¼‚æ­¥é«˜å¹¶å‘å¤„ç†**

### åŒå±‚éš”ç¦»æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¿ä¸»æœº (Host)                            â”‚
â”‚  â”œâ”€ Docker Engine / Kubernetes          â”‚
â”‚  â””â”€ è¿è¡Œæ—¶ç®¡ç†å™¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ åˆ›å»ºå®¹å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¹å™¨ (Container) - ç¬¬ä¸€å±‚éš”ç¦»            â”‚
â”‚  â”œâ”€ ç½‘ç»œéš”ç¦» (NetworkMode=none)          â”‚
â”‚  â”œâ”€ èµ„æºé™åˆ¶ (CPU/Memory/PID)            â”‚
â”‚  â””â”€ éç‰¹æƒç”¨æˆ· (sandbox:sandbox)         â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ‰§è¡Œå™¨è¿›ç¨‹ (Executor)               â”‚ â”‚
â”‚  â”‚  - ç›‘å¬ç®¡ç†ä¸­å¿ƒçš„æ‰§è¡Œè¯·æ±‚           â”‚ â”‚
â”‚  â”‚  - è°ƒç”¨ bwrap å¯åŠ¨ç”¨æˆ·ä»£ç           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â†“ è°ƒç”¨ bwrap                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Bubblewrap æ²™ç®± - ç¬¬äºŒå±‚éš”ç¦»       â”‚ â”‚
â”‚  â”‚  â”œâ”€ æ–°çš„å‘½åç©ºé—´ (PID/NET/MNT...)  â”‚ â”‚
â”‚  â”‚  â”œâ”€ åªè¯»æ–‡ä»¶ç³»ç»Ÿ                    â”‚ â”‚
â”‚  â”‚  â””â”€ seccomp ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤            â”‚ â”‚
â”‚  â”‚                                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ç”¨æˆ·ä»£ç è¿›ç¨‹                  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
sandbox/
â”œâ”€â”€ deploy/                   # Deployment configurations
â”‚   â”œâ”€â”€ k8s/                  # Kubernetes manifests
â”‚   â”œâ”€â”€ docker-compose/       # Docker Compose
â”‚   â””â”€â”€ helm/                 # Helm charts
â”‚
â”œâ”€â”€ sandbox_control_plane/    # FastAPI control plane
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ application/      # Business logic
â”‚   â”‚   â”œâ”€â”€ domain/           # Domain models
â”‚   â”‚   â”œâ”€â”€ infrastructure/   # External dependencies
â”‚   â”‚   â”œâ”€â”€ interfaces/       # REST API
â”‚   â”‚   â””â”€â”€ shared/           # Shared utilities
â”‚   â””â”€â”€ tests/                # Tests
â”‚
â”œâ”€â”€ sandbox_web/              # React web console
â”œâ”€â”€ runtime/executor/          # Sandbox executor daemon
â”œâ”€â”€ scripts/                  # Utility scripts
â””â”€â”€ docs/                     # Documentation (this directory)
```

---

## ğŸ”— ç›¸å…³èµ„æº

- **é¡¹ç›®ä¸»ç›®å½•**: `/Users/guochenguang/project/sandbox-v2/sandbox`
- **Control Plane ä»£ç **: `sandbox_control_plane/src/`
- **K8s é…ç½®æ–‡ä»¶**: `deploy/manifests/`
- **Helm Chart**: `deploy/helm/sandbox/`

---

## ğŸ“ æ–‡æ¡£ç‰ˆæœ¬

- **ç‰ˆæœ¬**: V2.1
- **æœ€åæ›´æ–°**: 2025-01-21
- **çŠ¶æ€**: å·²æ‹†åˆ†é‡æ„

---

**ğŸ‘‰ é€‰æ‹©ä¸Šæ–¹ç« èŠ‚å¼€å§‹é˜…è¯»ï¼Œæˆ–æŸ¥çœ‹å„ä¸ªå­æ–‡æ¡£äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚**
