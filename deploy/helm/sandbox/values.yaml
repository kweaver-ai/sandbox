# Default values for sandbox-platform Helm chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

global:
  # Namespace where all resources will be deployed
  namespace: sandbox-system
  # Runtime namespace for executor pods
  runtimeNamespace: sandbox-runtime
  # Image registry
  imageRegistry: ""
  # Image pull policy
  imagePullPolicy: IfNotPresent

# Control Plane configuration
controlPlane:
  enabled: true
  replicaCount: 1

  image:
    registry: ""
    repository: sandbox-control-plane
    tag: "latest"
    pullPolicy: IfNotPresent

  # Service configuration
  service:
    type: ClusterIP
    port: 8000
    annotations: {}

  # Ingress configuration
  ingress:
    enabled: false
    className: "nginx"
    annotations: {}
      # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: sandbox-control-plane.example.com
        paths:
          - path: /
            pathType: Prefix
    tls: []
    #  - secretName: sandbox-control-plane-tls
    #    hosts:
    #      - sandbox-control-plane.example.com

  # Resource limits and requests
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - sandbox-control-plane
            topologyKey: kubernetes.io/hostname

  # Environment variables from ConfigMap
  env:
    ENVIRONMENT: "staging"  # Changed to staging to enable auto table creation
    DEBUG: "false"
    DATABASE_URL: "mysql+aiomysql://root:password@mariadb.sandbox-system.svc.cluster.local:3306/sandbox"
    KUBERNETES_NAMESPACE: "sandbox-runtime"
    DEFAULT_TIMEOUT: "300"
    MAX_TIMEOUT: "3600"
    DEFAULT_CPU: "1"
    DEFAULT_MEMORY: "512Mi"
    DEFAULT_DISK: "1Gi"
    IDLE_THRESHOLD_MINUTES: "30"
    MAX_LIFETIME_HOURS: "6"
    CLEANUP_INTERVAL_SECONDS: "300"
    DISABLE_BWRAP: "true"
    PYTHONUNBUFFERED: "1"

  # S3/MinIO configuration
  s3:
    endpointUrl: "http://minio.sandbox-system.svc.cluster.local:9000"
    bucket: "sandbox-workspace"
    region: "us-east-1"

# Web Console configuration
web:
  enabled: true
  replicaCount: 1

  image:
    registry: ""
    repository: sandbox-web
    tag: "latest"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 80
    annotations: {}

  ingress:
    enabled: false
    className: "nginx"
    annotations: {}
    hosts:
      - host: sandbox-web.example.com
        paths:
          - path: /
            pathType: Prefix
    tls: []

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  nodeSelector: {}
  tolerations: []
  affinity: {}

# MariaDB configuration
mariadb:
  enabled: true
  replicaCount: 1

  image:
    registry: ""
    repository: mariadb
    tag: "11.2"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 3306

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Persistence
  persistence:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 10Gi

  # Database credentials
  auth:
    rootPassword: "password"
    database: "sandbox"
    username: ""
    password: ""

  nodeSelector: {}
  tolerations: []

# MinIO configuration
minio:
  enabled: true
  replicaCount: 1

  image:
    registry: ""
    repository: quay.io/minio/minio
    tag: "latest"
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    apiPort: 9000
    consolePort: 9001
    annotations: {}

  ingress:
    enabled: false
    className: "nginx"
    annotations: {}
    hosts:
      - host: minio.example.com
        paths:
          - path: /
            pathType: Prefix
    tls: []

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Persistence
  persistence:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 10Gi

  # Default buckets
  defaultBuckets:
    - sandbox-workspace

  # Root credentials
  auth:
    rootUser: "minioadmin"
    rootPassword: "minioadmin"

  nodeSelector: {}
  tolerations: []

# ServiceAccount configuration
serviceAccount:
  create: true
  name: "sandbox-control-plane"
  annotations: {}

# RBAC configuration
rbac:
  create: true
  name: "sandbox-control-plane"

# ConfigMap configuration
configMap:
  create: true
  name: "sandbox-config"

# Secret configuration
secret:
  create: true
  name: "sandbox-secrets"
  # S3 credentials (if external)
  s3:
    accessKeyId: "minioadmin"
    secretAccessKey: "minioadmin"
    region: "us-east-1"

# JuiceFS configuration (DISABLED - migrated to MinIO-only s3fs approach)
juicefs:
  enabled: false
  # CSI Driver (runs in kube-system namespace)
  csi:
    enabled: false
    image: juicedata/juicefs-csi-driver
    tag: v0.25.2
    namespace: kube-system
    logLevel: 5
  # Setup job (initializes JuiceFS database and format)
  setup:
    enabled: false
    image: juicedata/juicefs-fuse
    tag: ce-nightly
    # JuiceFS metadata database URL
    # Note: Must use tcp(host:port) format for Go MySQL driver
    metaUrl: "mysql://root:password@tcp(mariadb.sandbox-system.svc.cluster.local:3306)/juicefs_metadata"
    # Storage backend configuration
    storageType: "minio"
    bucket: "http://minio.sandbox-system.svc.cluster.local:9000/sandbox-workspace"
    accessKey: "minioadmin"
    secretKey: "minioadmin"
    # Database credentials
    dbUser: "juicefs"
    dbPassword: "juicefs_password"
  # HostPath DaemonSet (mount helper for executor pods)
  hostPath:
    enabled: false
    mountPath: "/var/jfs"   # JuiceFS mount point inside mount-helper container
    hostPath: "/var/jfs"    # Host path that will be mounted into control-plane/executor pods

# Runtime namespace configuration
runtimeNamespace:
  create: true
  name: "sandbox-runtime"

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
