version: '3.8'

services:
  control-plane:
    build:
      context: ../../sandbox_control_plane
      dockerfile: Dockerfile
    container_name: sandbox-control-plane
    ports:
      - "8000:8000" # Map to host for testing
    networks:
      - sandbox_network
    volumes:
      # Mount Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
    # 资源限制（实际运行约 600MB）
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 600M
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=mysql+aiomysql://root:password@mariadb:3306/sandbox
      - DOCKER_HOST=unix:///var/run/docker.sock
      - EXECUTOR_PORT=8080
      - CONTROL_PLANE_URL=http://control-plane:8000
      - DEFAULT_TIMEOUT=300
      - MAX_TIMEOUT=3600
      - WARM_POOL_ENABLED=false
      - DISABLE_BWRAP=true # 本地开发禁用 Bubblewrap
      # S3/MinIO Configuration
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY_ID=minioadmin
      - S3_SECRET_ACCESS_KEY=minioadmin
      - S3_BUCKET=sandbox-workspace
      - S3_REGION=us-east-1
    depends_on:
      mariadb:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  sandbox-web:
    build:
      context: ../../sandbox_web
      dockerfile: Dockerfile
    container_name: sandbox-web
    ports:
      - "1101:80" # Map internal 3000 to host 1101
    networks:
      - sandbox_network
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    environment:
      - NODE_ENV=production
      - VITE_API_BASE_URL=http://control-plane:8000
    depends_on:
      control-plane:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  minio:
    image: quay.io/minio/minio:latest
    container_name: sandbox-minio
    ports:
      - "9000:9000" # MinIO API
      - "9001:9001" # MinIO Console
    networks:
      - sandbox_network
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_DEFAULT_BUCKETS: sandbox-workspace
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  mariadb:
    image: mariadb:11.2
    container_name: sandbox-mariadb
    networks:
      - sandbox_network
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=sandbox
    volumes:
      - mariadb_data:/var/lib/mysql
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mariadb", "-u", "root", "-ppassword", "-e", "SELECT 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  sandbox_network:
    driver: bridge
    name: sandbox_network

volumes:
  minio_data:
  mariadb_data:
